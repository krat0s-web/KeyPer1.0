# Documentation du Code M√©t√©o - KeyPer

Ce fichier contient toutes les parties de code li√©es √† la fonctionnalit√© m√©t√©o de votre projet KeyPer.
Vous pouvez copier ces sections dans votre projet original pour int√©grer la fonctionnalit√© m√©t√©o.

---

## üìã TABLE DES MATI√àRES

1. [Mod√®le - Champ villes_favorites_meteo](#1-mod√®le---champ-villes_favorites_meteo)
2. [Migration - Ajout du champ villes_favorites_meteo](#2-migration---ajout-du-champ-villes_favorites_meteo)
3. [Settings - Configuration OpenWeatherMap](#3-settings---configuration-openweathermap)
4. [API Client - Fonction get_weather_data](#4-api-client---fonction-get_weather_data)
5. [Views - Import de l'API client](#5-views---import-de-lapi-client)
6. [Views - Fonction dashboard (partie m√©t√©o)](#6-views---fonction-dashboard-partie-m√©t√©o)
7. [Views - API get_weather](#7-views---api-get_weather)
8. [Views - API add_favorite_city](#8-views---api-add_favorite_city)
9. [Views - API remove_favorite_city](#9-views---api-remove_favorite_city)
10. [Views - Fonction get_clothing_recommendation](#10-views---fonction-get_clothing_recommendation)
11. [URLs - Routes API m√©t√©o](#11-urls---routes-api-m√©t√©o)
12. [Template - HTML m√©t√©o dans dashboard.html](#12-template---html-m√©t√©o-dans-dashboardhtml)
13. [Template - JavaScript m√©t√©o dans dashboard.html](#13-template---javascript-m√©t√©o-dans-dashboardhtml)

---

## 1. MOD√àLE - Champ villes_favorites_meteo

**Fichier :** `maison_app/models.py`

**Localisation :** Dans la classe `Utilisateur`, apr√®s le champ `photo_profil`

```python
# Dans la classe Utilisateur (ligne ~44)
villes_favorites_meteo = models.JSONField(default=list, blank=True)
```

**Note :** Ce champ stocke une liste de noms de villes favorites pour la m√©t√©o.

---

## 2. MIGRATION - Ajout du champ villes_favorites_meteo

**Fichier :** `maison_app/migrations/0026_utilisateur_villes_favorites_meteo.py`

**Action :** Cr√©er ce fichier de migration et l'appliquer avec `python manage.py migrate`

```python
# Generated by Django 6.0 on 2025-12-08 09:15

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('maison_app', '0025_inventaire_quantite_alerte_min'),  # ‚ö†Ô∏è ADAPTER selon votre derni√®re migration
    ]

    operations = [
        migrations.AddField(
            model_name='utilisateur',
            name='villes_favorites_meteo',
            field=models.JSONField(blank=True, default=list),
        ),
    ]
```

**Note :** Adaptez le `dependencies` selon votre derni√®re migration existante.

---

## 3. SETTINGS - Configuration OpenWeatherMap

**Fichier :** `gestion_taches_project/settings.py`

**Localisation :** √Ä la fin du fichier, dans la section des configurations API

```python
# Configuration OpenWeatherMap 
OPENWEATHERMAP_API_KEY = "0cc4a7fe756e2a2831352c60f062aad0" 
OPENWEATHERMAP_URL = "http://api.openweathermap.org/data/2.5/weather"
```

**Note :** Vous pouvez aussi utiliser une variable d'environnement pour la cl√© API.

---

## 4. API CLIENT - Fonction get_weather_data

**Fichier :** `maison_app/api_clients.py`

**Action :** Si ce fichier n'existe pas, cr√©ez-le. Si il existe, ajoutez la fonction.

```python
import requests
from django.conf import settings

def get_weather_data(city_name):
    """
    R√©cup√®re les donn√©es m√©t√©o pour une ville donn√©e.
    """
    # R√©cup√©rer la cl√© et l'URL d√©finies dans settings.py
    api_key = settings.OPENWEATHERMAP_API_KEY
    url = settings.OPENWEATHERMAP_URL
    
    # Param√®tres de la requ√™te
    params = {
        'q': city_name,
        'appid': api_key,
        'units': 'metric', # Pour obtenir les temp√©ratures en Celsius
        'lang': 'fr'      # Pour les descriptions en fran√ßais
    }
    
    try:
        response = requests.get(url, params=params)
        response.raise_for_status() # L√®ve une exception pour les erreurs HTTP (4xx ou 5xx)
        
        data = response.json()
        
        # Filtrer et formater les donn√©es pertinentes
        weather_data = {
            'city': data.get('name'),
            'temp': round(data['main']['temp']),
            'description': data['weather'][0]['description'].capitalize(),
            'main': data['weather'][0]['main'],
            'icon': data['weather'][0]['icon'],
            'temp_min': round(data['main']['temp_min']),
            'temp_max': round(data['main']['temp_max']),
        }
        return weather_data
        
    except requests.exceptions.RequestException as e:
        print(f"Erreur lors de l'appel API OpenWeatherMap: {e}")
        return None
    except KeyError:
        # Erreur si la structure de la r√©ponse JSON n'est pas celle attendue (ville non trouv√©e, etc.)
        print("Erreur: Structure de donn√©es m√©t√©o invalide.")
        return None
```

**Note :** Cette fonction n√©cessite le package `requests` (installer avec `pip install requests`).

---

## 5. VIEWS - Import de l'API client

**Fichier :** `maison_app/views.py`

**Localisation :** Dans les imports en haut du fichier (ligne ~22)

```python
from .api_clients import get_weather_data, search_cities_geonames
```

**Note :** Si vous n'utilisez pas `search_cities_geonames`, vous pouvez importer uniquement `get_weather_data`.

---

## 6. VIEWS - Fonction dashboard (partie m√©t√©o)

**Fichier :** `maison_app/views.py`

**Localisation :** Dans la fonction `dashboard`, juste avant le `return render(...)` (lignes ~1080-1125)

```python
    # Meteo Favorite
    initial_weather = None
    
    # V√©rifie si l'utilisateur a des villes favorites et que la liste n'est pas vide
    if request.user.villes_favorites_meteo and len(request.user.villes_favorites_meteo) > 0:
        try:
            # R√©cup√®re la premi√®re ville favorite
            first_favorite_city = request.user.villes_favorites_meteo[0]
            
            # R√©cup√®re les donn√©es m√©t√©o via l'API client
            weather_data = get_weather_data(first_favorite_city)
            
            if weather_data:
                # Calcule la recommandation vestimentaire
                temp = weather_data.get('temp')
                weather_main = weather_data.get('main')
                
                # Appel de la fonction de recommandation
                reco = get_clothing_recommendation(temp, weather_main) 
                
                # Ajoute les donn√©es de recommandation au dictionnaire
                weather_data['reco_text'] = reco['text']
                weather_data['reco_image_tag'] = reco['image_tag']
                weather_data['reco_class'] = reco['class']
                
                initial_weather = weather_data
                
        except Exception as e:
            # En cas d'erreur (API, liste mal format√©e, etc.)
            print(f"Erreur lors du chargement de la m√©t√©o initiale: {e}")
            initial_weather = None
    
    return render(request, 'maison_app/dashboard.html', {
        # ... vos autres contextes existants ...
        'initial_weather': initial_weather,  # ‚ö†Ô∏è AJOUTER cette ligne dans votre contexte
    })
```

**Note :** N'oubliez pas d'ajouter `'initial_weather': initial_weather` dans le dictionnaire de contexte du `render()`.

---

## 7. VIEWS - API get_weather

**Fichier :** `maison_app/views.py`

**Localisation :** √Ä la fin du fichier, avec les autres vues API (lignes ~2707-2734)

```python
@login_required
def api_get_weather(request):
    """
    R√©cup√®re les donn√©es m√©t√©o pour une ville demand√©e par l'utilisateur (via AJAX)
    et ajoute une recommandation vestimentaire bas√©e sur la temp√©rature ET l'√©tat du ciel.
    """
    city = request.GET.get('city', '').strip()
    
    if not city:
        return JsonResponse({'error': 'Veuillez fournir un nom de ville.'}, status=400)
    
    meteo_data = get_weather_data(city)
    
    if meteo_data:
        # R√©cup√©rer les donn√©es n√©cessaires pour la recommandation
        temp = meteo_data.get('temp')
        weather_main = meteo_data.get('main')  # R√©cup√©ration de l'√©tat principal (Rain, Clear, etc.)

        # Appel de la fonction avec la temp√©rature ET l'√©tat principal
        reco = get_clothing_recommendation(temp, weather_main) 
        
        # Ajouter les donn√©es de recommandation au JSON de r√©ponse
        meteo_data['reco_text'] = reco['text']
        meteo_data['reco_image_tag'] = reco['image_tag'] # 'tenue_pluie', 'tenue_ete', etc.
        meteo_data['reco_class'] = reco['class']
        
        return JsonResponse(meteo_data)
    else:
        return JsonResponse({'error': 'Ville non trouv√©e ou erreur API.'}, status=404)
```

---

## 8. VIEWS - API add_favorite_city

**Fichier :** `maison_app/views.py`

**Localisation :** Apr√®s `api_get_weather` (lignes ~2736-2764)

```python
@login_required
def api_add_favorite_city(request):
    """API pour ajouter une ville aux favoris de l'utilisateur."""
    if request.method == 'POST':
        try:
            data = json.loads(request.body)
            city_name = data.get('city', '').strip()
        except json.JSONDecodeError:
            return JsonResponse({'error': 'Donn√©es JSON invalides.'}, status=400)
            
        if not city_name:
            return JsonResponse({'error': 'Nom de ville requis.'}, status=400)
            
        favorites = request.user.villes_favorites_meteo
        
        if city_name not in favorites:
            # Limite de s√©curit√©
            if len(favorites) >= 10:
                return JsonResponse({'error': 'Vous avez atteint la limite de 10 villes favorites.'}, status=400)

            favorites.append(city_name)
            request.user.villes_favorites_meteo = favorites
            request.user.save()
            
            return JsonResponse({'success': True, 'message': f"'{city_name}' ajout√© aux favoris."})
        else:
            return JsonResponse({'error': 'Cette ville est d√©j√† dans vos favoris.'}, status=400)
            
    return JsonResponse({'error': 'M√©thode non autoris√©e.'}, status=405)
```

**Note :** Assurez-vous d'avoir `import json` en haut du fichier.

---

## 9. VIEWS - API remove_favorite_city

**Fichier :** `maison_app/views.py`

**Localisation :** Apr√®s `api_add_favorite_city` (lignes ~2767-2790)

```python
@login_required
def api_remove_favorite_city(request):
    """API pour supprimer une ville des favoris de l'utilisateur."""
    if request.method == 'POST':
        try:
            data = json.loads(request.body)
            city_name = data.get('city', '').strip()
        except json.JSONDecodeError:
            return JsonResponse({'error': 'Donn√©es JSON invalides.'}, status=400)
            
        if not city_name:
            return JsonResponse({'error': 'Nom de ville requis.'}, status=400)

        favorites = request.user.villes_favorites_meteo
        
        if city_name in favorites:
            favorites.remove(city_name)
            request.user.villes_favorites_meteo = favorites
            request.user.save()
            return JsonResponse({'success': True, 'message': f"'{city_name}' retir√© des favoris."})
        else:
            return JsonResponse({'error': 'Cette ville n\'est pas dans vos favoris.'}, status=400)

    return JsonResponse({'error': 'M√©thode non autoris√©e.'}, status=405)
```

---

## 10. VIEWS - Fonction get_clothing_recommendation

**Fichier :** `maison_app/views.py`

**Localisation :** Apr√®s `api_remove_favorite_city` (lignes ~2792-2827)

```python
def get_clothing_recommendation(temp, weather_main):
    """D√©termine la recommandation vestimentaire en fonction de la temp√©rature et de l'√©tat du ciel."""
    
    # 1. Condition Sp√©cifique : PLUIE (Prime sur la temp√©rature)
    if weather_main in ['Rain', 'Drizzle', 'Thunderstorm']:
        return {
            'text': "Attention, il pleut ! Tenue imperm√©able.",
            'image_tag': 'tenue_pluvieuse',
            'class': 'bg-info text-dark'
        }

    # 2. Condition bas√©e sur la Temp√©rature (si pas de pluie)
    
    # Tenue d'hiver (Froid)
    if temp <= 10:
        return {
            'text': "Froid - Tenue d'hiver recommand√©e !",
            'image_tag': 'tenue_hiver', 
            'class': 'bg-primary'
        }
    
    # Tenue normale (Interm√©diaire)
    elif 11 <= temp <= 25:
        return {
            'text': "Temp√©rature agr√©able - Tenue normale.",
            'image_tag': 'tenue_normale',
            'class': 'bg-warning text-dark'
        }
    
    # Tenue d'√©t√© (Chaud)
    else: # temp >= 26
        return {
            'text': "Chaud - Tenue l√©g√®re (d'√©t√©) recommand√©e.",
            'image_tag': 'tenue_ete',
            'class': 'bg-danger'
        }
```

**Note :** Cette fonction n√©cessite des images dans `static/images/vetements/` :
- `tenue_pluvieuse.png`
- `tenue_hiver.png`
- `tenue_normale.png`
- `tenue_ete.png`

---

## 11. URLS - Routes API m√©t√©o

**Fichier :** `gestion_taches_project/urls.py`

**Localisation :** Dans la liste `urlpatterns`, avec les autres routes API (lignes ~64-67)

```python
    path('api/get-weather/', views.api_get_weather, name='api_get_weather'),
    path('api/meteo/favorite/add/', views.api_add_favorite_city, name='api_add_favorite_city'),
    path('api/meteo/favorite/remove/', views.api_remove_favorite_city, name='api_remove_favorite_city'),
```

**Note :** Si vous utilisez l'autocompl√©tion de villes, ajoutez aussi :
```python
    path('api/search-city/', views.api_search_city, name='api_search_city'),
```

---

## 12. TEMPLATE - HTML m√©t√©o dans dashboard.html

**Fichier :** `maison_app/templates/maison_app/dashboard.html`

**Localisation :** Dans le contenu principal, o√π vous souhaitez afficher le bloc m√©t√©o (lignes ~68-159)

```html
{# --- BLOC M√âT√âO DYNAMIQUE --- #}
<div class="row mb-4 g-3">
    <div class="col-md-12">
        <div class="card border-0 shadow-lg rounded-4">
            <div class="card-body p-4">
                <h5 class="mb-3"><i class="bi bi-cloud-sun me-2"></i> Consulter la M√©t√©o</h5>
                
                {# Zone de recherche et bouton #}
                <div class="input-group">
                    <input type="text" 
                           id="city-search"
                           class="form-control"
                           placeholder="Rechercher une ville pour la m√©t√©o..."
                           aria-label="Rechercher une ville"
                           required>
                    <button type="button" class="btn btn-primary" id="load-weather-btn">
                        <i class="bi bi-search me-1"></i> Afficher M√©t√©o
                    </button>
                </div>
                
                {# Zone pour les suggestions d'autocompl√©tion #}
                <ul id="city-suggestions" class="list-group position-absolute w-100 mt-1" style="z-index: 1000; max-height: 200px; overflow-y: auto; display: none;"></ul>
                
                {# --- BLOC M√âT√âO FAVORIS & R√âSULTATS --- #}
                <div class="mt-4">
                    {# Affichage des favoris #}
                    <div id="favorites-list" class="mb-3">
                        {% if user.villes_favorites_meteo %}
                        <p class="text-muted small mb-1">Vos favoris :</p>
                        <div class="d-flex flex-wrap gap-2">
                            {% for city in user.villes_favorites_meteo %}
                            <button type="button" class="btn btn-sm btn-outline-secondary favorite-city-tag" data-city="{{ city }}">
                                <i class="bi bi-geo-alt"></i> {{ city }}
                            </button>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    {# Conteneur des r√©sultats M√âT√âO (avec pr√©-chargement) #}
                    <div id="weather-results" class="mt-3">
                        {% if initial_weather %}
                        <div class="card border-0 shadow-lg rounded-4 mb-4" style="background: linear-gradient(45deg, #0d6efd, #0dcaf0); color: white;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4 class="mb-0"><i class="bi bi-cloud-sun me-2"></i> M√©t√©o √† {{ initial_weather.city }}</h4>
                                    
                                    <button type="button" class="btn btn-sm btn-danger remove-favorite-btn" data-city="{{ initial_weather.city }}" title="Retirer des favoris">
                                        <i class="bi bi-star-fill"></i> Retirer
                                    </button>
                                </div>
                                <div class="d-flex align-items-center mb-4">
                                    <img src="http://openweathermap.org/img/wn/{{ initial_weather.icon }}@2x.png" alt="{{ initial_weather.description }}" style="width: 80px;">
                                    <div class="ms-3">
                                        <h1 class="mb-0">{{ initial_weather.temp }}¬∞C</h1>
                                        <p class="lead mb-0">{{ initial_weather.description }}</p>
                                        <small>Min: {{ initial_weather.temp_min }}¬∞C / Max: {{ initial_weather.temp_max }}¬∞C</small>
                                    </div>
                                </div>
                                
                                {# BLOC RECOMMANDATION INITIALE #}
                                <div class="row align-items-center mt-3 p-2 rounded {{ initial_weather.reco_class }}" style="opacity: 0.9; color: white;">
                                    <div class="col-6 text-start">
                                        <p class="mb-0 fw-bold">{{ initial_weather.reco_text }}</p>
                                    </div>
                                    <div class="col-6 text-end">
                                        {# Le chemin statique utilise le tag correct transmis par la vue #}
                                        <img src="{% static 'images/vetements/' %}{{ initial_weather.reco_image_tag }}.png" alt="{{ initial_weather.reco_image_tag }}" style="height: 60px;">
                                    </div>
                                </div>
                                {# FIN BLOC RECOMMANDATION INITIALE #}

                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info text-center" role="alert">
                            {% if user.villes_favorites_meteo %}
                            Impossible de charger la m√©t√©o pour la premi√®re ville favorite. Veuillez r√©essayer.
                            {% else %}
                            S√©lectionnez une ville pour afficher la m√©t√©o.
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {# --- FIN BLOC M√âT√âO FAVORIS & R√âSULTATS --- #}

            </div>
        </div>
    </div>
</div>
{# --- FIN BLOC M√âT√âO DYNAMIQUE --- #}
```

**Note :** Assurez-vous d'avoir `{% load static %}` en haut du template si vous utilisez `{% static %}`.

---

## 13. TEMPLATE - JavaScript m√©t√©o dans dashboard.html

**Fichier :** `maison_app/templates/maison_app/dashboard.html`

**Localisation :** Dans un bloc `<script>` √† la fin du template, avant `{% endblock %}` (lignes ~440-646)

```javascript
<script>
$(document).ready(function() {
    // S√©lecteurs
    const searchInput = $('#city-search');
    const suggestionsList = $('#city-suggestions');
    const loadWeatherBtn = $('#load-weather-btn');
    const weatherResults = $('#weather-results');
    const favoritesContainer = $('#favorites-list');
    let timeout = null;
    
    // üí° D√©finition de l'URL Statique de base pour les images de v√™tements
    const STATIC_URL_BASE = "{% static 'images/vetements/' %}";


    // --- UTILS : CSRF et Gestion des Favoris ---

    // Fonction utilitaire pour obtenir le token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const handleFavoriteAction = function(city, actionUrl, verb) {
        $.ajax({
            url: actionUrl,
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            contentType: 'application/json',
            data: JSON.stringify({ city: city }),
            success: function(response) {
                // Actualiser la liste de favoris (m√©thode simple : recharger la page)
                window.location.reload(); 
            },
            error: function(xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : `Erreur lors de l'action ${verb}.`;
                alert(error);
            }
        });
    };

    // --- GESTION DE L'AUTOCOMPL√âTION (GeoNames API) ---
    // ‚ö†Ô∏è OPTIONNEL : Si vous n'utilisez pas l'autocompl√©tion, vous pouvez supprimer cette section
    searchInput.on('keyup', function() {
        clearTimeout(timeout);
        const query = $(this).val();
        loadWeatherBtn.prop('disabled', true); 
        suggestionsList.empty().hide();

        if (query.length < 2) {
            return;
        }

        timeout = setTimeout(function() {
            $.ajax({
                url: '{% url "api_search_city" %}',
                data: { 'q': query },
                dataType: 'json',
                success: function(data) {
                    if (data.length > 0) {
                        $.each(data, function(index, city) {
                            const listItem = $('<li class="list-group-item list-group-item-action"></li>')
                                .text(city)
                                .on('click', function() {
                                    searchInput.val(city);
                                    suggestionsList.empty().hide();
                                    loadWeatherBtn.prop('disabled', false).focus(); 
                                });
                            suggestionsList.append(listItem);
                        });
                        suggestionsList.show();
                    }
                }
            });
        }, 300);
    });
    
    // Cacher les suggestions lorsqu'on clique en dehors
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#city-search, #city-suggestions').length) {
            suggestionsList.hide();
        }
    });

    // --- GESTION DE L'AFFICHAGE DE LA M√âT√âO (OpenWeatherMap API) ---
    
    const loadWeather = function(cityToLoad) {
        const city = cityToLoad || searchInput.val().trim();
        if (!city) return;

        weatherResults.html('<div class="alert alert-warning text-center">Chargement des donn√©es m√©t√©o...</div>');
        loadWeatherBtn.prop('disabled', true);
        
        $.ajax({
            url: '{% url "api_get_weather" %}',
            data: { 'city': city },
            dataType: 'json',
            success: function(data) {
                
                // R√©cup√©rer les donn√©es de recommandation
                const recoText = data.reco_text;
                const recoTag = data.reco_image_tag; // ex: 'tenue_ete'
                const recoClass = data.reco_class;   // ex: 'bg-danger'

                // V√©rifier si la ville est d√©j√† dans les favoris
                const isFavorite = favoritesContainer.find(`[data-city="${data.city}"]`).length > 0;
                
                const favoriteButton = isFavorite 
                    ? `<button type="button" class="btn btn-sm btn-danger remove-favorite-btn" data-city="${data.city}" title="Retirer des favoris"><i class="bi bi-star-fill"></i> Retirer</button>`
                    : `<button type="button" class="btn btn-sm btn-warning add-favorite-btn" data-city="${data.city}" title="Ajouter aux favoris"><i class="bi bi-star"></i> Ajouter aux Favoris</button>`;
                
                const htmlContent = `
                <div class="card border-0 shadow-lg rounded-4 mb-4" style="background: linear-gradient(45deg, #0d6efd, #0dcaf0); color: white;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="mb-0"><i class="bi bi-cloud-sun me-2"></i> M√©t√©o √† ${data.city}</h4>
                            ${favoriteButton}
                        </div>
                        <div class="d-flex align-items-center mb-4">
                            <img src="http://openweathermap.org/img/wn/${data.icon}@2x.png" alt="${data.description}" style="width: 80px;">
                            <div class="ms-3">
                                <h1 class="mb-0">${data.temp}¬∞C</h1>
                                <p class="lead mb-0">${data.description}</p>
                                <small>Min: ${data.temp_min}¬∞C / Max: ${data.temp_max}¬∞C</small>
                            </div>
                        </div>
                        
                        {# BLOC RECOMMANDATION VESTIMENTAIRE (G√âN√âR√â DYNAMIQUE) #}
                        <div class="row align-items-center mt-3 p-2 rounded ${recoClass}" style="opacity: 0.9; color: white;">
                            <div class="col-6 text-start">
                                <p class="mb-0 fw-bold">${recoText}</p>
                            </div>
                            <div class="col-6 text-end">
                                <img src="${STATIC_URL_BASE}${recoTag}.png" alt="${recoTag}" style="height: 60px;">
                            </div>
                        </div>
                        {# FIN BLOC RECOMMANDATION #}

                    </div>
                </div>
                `;
                weatherResults.html(htmlContent);

                // R√©attacher les gestionnaires d'√©v√©nements aux nouveaux boutons
                $('.add-favorite-btn').on('click', function() {
                    const city = $(this).data('city');
                    handleFavoriteAction(city, '{% url "api_add_favorite_city" %}', 'ajout');
                });

                $('.remove-favorite-btn').on('click', function() {
                    const city = $(this).data('city');
                    handleFavoriteAction(city, '{% url "api_remove_favorite_city" %}', 'retrait');
                });
                
            },
            error: function(xhr) {
                const errorMessage = xhr.responseJSON && xhr.responseJSON.error 
                                     ? xhr.responseJSON.error 
                                     : "Impossible de r√©cup√©rer les donn√©es m√©t√©o. Veuillez v√©rifier le nom de la ville.";
                weatherResults.html(`<div class="alert alert-danger text-center" role="alert"><i class="bi bi-x-circle me-2"></i> ${errorMessage}</div>`);
            },
            complete: function() {
                loadWeatherBtn.prop('disabled', false);
            }
        });
    };

    // --- √âV√âNEMENTS GLOBAUX ---

    loadWeatherBtn.on('click', function() {
        loadWeather();
    });
    
    // Chargement de la m√©t√©o via les tags de favoris existants (pour les favoris affich√©s par Django)
    $('.favorite-city-tag').on('click', function() {
        const city = $(this).data('city');
        searchInput.val(city); // Remplir le champ de recherche
        loadWeather(city);
    });

    // √âv√©nement sp√©cifique pour le bouton de retrait pr√©-rendu (m√©t√©o initiale)
    // Nous devons utiliser un gestionnaire d'√©v√©nements d√©l√©gu√© car ce bouton est remplac√© par AJAX
    $(document).on('click', '.remove-favorite-btn', function() {
        const city = $(this).data('city');
        handleFavoriteAction(city, '{% url "api_remove_favorite_city" %}', 'retrait');
    });


    // Permettre de charger la m√©t√©o en appuyant sur Entr√©e dans le champ de recherche
    searchInput.on('keypress', function(e) {
        if (e.which === 13) {
            e.preventDefault(); 
            if (!loadWeatherBtn.prop('disabled')) {
                loadWeather();
            }
        }
    });

    // üí° D√©chargement initial du bouton de m√©t√©o si le champ de recherche est vide
    if (searchInput.val().trim() === '') {
        loadWeatherBtn.prop('disabled', true);
    }
});
</script>
```

**Note :** Ce code n√©cessite jQuery. Assurez-vous qu'il est charg√© dans votre template.

---

## üìù NOTES IMPORTANTES

### D√©pendances Python
- `requests` : Pour les appels API
  ```bash
  pip install requests
  ```

### Images n√©cessaires
Cr√©ez un dossier `static/images/vetements/` et ajoutez les images suivantes :
- `tenue_pluvieuse.png`
- `tenue_hiver.png`
- `tenue_normale.png`
- `tenue_ete.png`

### Autocompl√©tion (optionnel)
Si vous souhaitez utiliser l'autocompl√©tion de villes, vous aurez besoin de :
1. Configurer GeoNames dans `settings.py` :
   ```python
   GEONAMES_USERNAME = "votre_username"
   GEONAMES_URL = "http://secure.geonames.org/searchJSON"
   ```
2. Ajouter la fonction `search_cities_geonames` dans `api_clients.py`
3. Cr√©er la vue `api_search_city` dans `views.py`
4. Ajouter la route correspondante dans `urls.py`

### Ordre d'int√©gration recommand√©
1. Mod√®le et migration
2. Settings (configuration API)
3. API client (`api_clients.py`)
4. Views (fonctions API et dashboard)
5. URLs
6. Template (HTML + JavaScript)

---

## ‚úÖ CHECKLIST D'INT√âGRATION

- [ ] Ajout du champ `villes_favorites_meteo` dans le mod√®le `Utilisateur`
- [ ] Cr√©ation et application de la migration
- [ ] Configuration OpenWeatherMap dans `settings.py`
- [ ] Cr√©ation/ajout de `get_weather_data` dans `api_clients.py`
- [ ] Import de `get_weather_data` dans `views.py`
- [ ] Ajout du code m√©t√©o dans la fonction `dashboard`
- [ ] Cr√©ation de `api_get_weather`
- [ ] Cr√©ation de `api_add_favorite_city`
- [ ] Cr√©ation de `api_remove_favorite_city`
- [ ] Cr√©ation de `get_clothing_recommendation`
- [ ] Ajout des routes dans `urls.py`
- [ ] Ajout du HTML m√©t√©o dans `dashboard.html`
- [ ] Ajout du JavaScript m√©t√©o dans `dashboard.html`
- [ ] Cr√©ation des images de v√™tements dans `static/images/vetements/`
- [ ] Installation de `requests` si n√©cessaire
- [ ] Test de la fonctionnalit√© compl√®te

---

**Fin de la documentation**

