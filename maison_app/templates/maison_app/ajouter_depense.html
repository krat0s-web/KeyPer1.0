{% extends "maison_app/dashboard_base.html" %}
{% load static %}
{% block page_title %}Ajouter D√©pense{% endblock %}
{% block page_heading %}Ajouter D√©pense{% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
    <li><a href="{% url 'dashboard' %}">Dashboard</a></li>
    /
    <li><a href="{% url 'budget_foyer' %}">Budget</a></li>
    /
    <li><a href="#" class="active">Ajouter D√©pense</a></li>
</ul>
{% endblock %}

{% block page_content %}
<div class="card-dashboard" style="max-width: 700px; margin: 0 auto;">
    <div style="background: linear-gradient(135deg, var(--primary), var(--light-primary)); color: var(--light); padding: 24px; border-radius: 12px 12px 0 0;">
        <h3 style="margin: 0; color: #ffffff; display: flex; align-items: center; gap: 12px; font-weight: 600;">
            <i class='bx bx-money' style="font-size: 28px; color: #ffffff;"></i>Ajouter D√©pense
        </h3>
        <p style="margin: 8px 0 0 0; color: rgba(255,255,255,0.9); font-size: 14px;">Foyer: <strong>{{ foyer.nom }}</strong></p>
    </div>
    
    <div style="padding: 24px;">
        <!-- Alertes avant ajout -->
        {% if alertes_avant_ajout %}
        <div style="margin-bottom: 24px;">
            {% for alerte in alertes_avant_ajout %}
            <div class="card-dashboard" style="background: {% if alerte.type == 'danger' %}var(--light-danger){% else %}var(--light-warning){% endif %}; color: {% if alerte.type == 'danger' %}var(--danger){% else %}var(--dark){% endif %}; padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid {% if alerte.type == 'danger' %}var(--danger){% else %}var(--warning){% endif %};">
                <h5 style="margin: 0 0 8px 0; color: {% if alerte.type == 'danger' %}var(--danger){% else %}var(--dark){% endif %};">
                    {% if alerte.type == 'danger' %}
                        üö® Alerte Critique
                    {% else %}
                        ‚ö†Ô∏è Attention
                    {% endif %}
                </h5>
                <p style="margin: 0 0 8px 0; color: var(--dark);">{{ alerte.message }}</p>
                {% if alerte.type == 'danger' %}
                <hr style="border: none; border-top: 1px solid var(--grey); margin: 8px 0;">
                <p style="margin: 0 0 4px 0; color: var(--dark); font-weight: 500;"><strong>D√©tails :</strong></p>
                <ul style="margin: 0; padding-left: 20px; color: var(--dark);">
                    <li>Montant actuel utilis√© : {{ alerte.montant_actuel|floatformat:2 }}‚Ç¨</li>
                    <li>Limite du budget : {{ alerte.montant_limite|floatformat:2 }}‚Ç¨</li>
                    <li>Montant apr√®s ajout : {{ alerte.montant_apres|floatformat:2 }}‚Ç¨</li>
                    <li style="color: var(--danger); font-weight: 600;"><strong>D√©passement : {{ alerte.depassement|floatformat:2 }}‚Ç¨</strong></li>
                </ul>
                {% endif %}
            </div>
            {% endfor %}
            <div class="card-dashboard" style="background: var(--light-primary); padding: 16px; border-radius: 8px; border-left: 4px solid var(--primary);">
                <i class='bx bx-info-circle' style="color: var(--primary); margin-right: 8px;"></i>
                <strong style="color: var(--dark);">üí° Conseil :</strong> Vous pouvez quand m√™me ajouter cette d√©pense, mais le budget sera d√©pass√©. 
                Pensez √† r√©viser votre budget si n√©cessaire.
            </div>
        </div>
        {% endif %}

        <form method="POST">
            {% csrf_token %}
            
            {% if depense_preview %}
            <!-- Pr√©visualisation de la d√©pense -->
            <input type="hidden" name="description" value="{{ depense_preview.description }}">
            <input type="hidden" name="montant" value="{{ depense_preview.montant }}">
            <input type="hidden" name="categorie_principale" value="{{ depense_preview.categorie_id }}">
            <input type="hidden" name="date_depense" value="{{ depense_preview.date_depense }}">
            <input type="hidden" name="notes" value="{{ depense_preview.notes }}">
            {% endif %}
            
            <div style="display: grid; gap: 20px;">
                <div>
                    <label for="description" style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500; display: flex; align-items: center; gap: 4px;">
                        <i class='bx bx-text'></i>üìù Description
                    </label>
                    <input type="text" id="description" name="description" 
                           placeholder="Ex: Courses au march√©" value="{% if depense_preview %}{{ depense_preview.description }}{% endif %}" required
                           style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                </div>

                <div>
                    <label for="montant" style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500; display: flex; align-items: center; gap: 4px;">
                        <i class='bx bx-money'></i>üíµ Montant
                    </label>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="montant" name="montant" 
                               placeholder="0.00" step="0.01" min="0" value="{% if depense_preview %}{{ depense_preview.montant }}{% endif %}" required
                               style="flex: 1; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                        <span style="padding: 12px; background: var(--grey); color: var(--dark); border-radius: 8px; display: flex; align-items: center;">‚Ç¨</span>
                    </div>
                    <small style="color: var(--dark-grey); font-size: 12px;">Minimum : 0 ‚Ç¨ (pas de valeurs n√©gatives)</small>
                </div>

                <div>
                    <label style="display: block; margin-bottom: 12px; color: var(--dark); font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class='bx bx-tag'></i>üè∑Ô∏è Cat√©gorie Principale
                    </label>
                    
                    {% if not depense_preview %}
                    <!-- Grille de cat√©gories visuelles -->
                    <div id="categories_grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-bottom: 12px;">
                        {% for cat in categories_principales %}
                        <button type="button" class="categorie-card" 
                                data-categorie-id="{{ cat.id }}"
                                data-categorie-nom="{{ cat.nom }}"
                                onclick="selectCategorie({{ cat.id }}, '{{ cat.nom }}', '{{ cat.icone }}', '{{ cat.couleur }}')"
                                style="padding: 16px; border: 2px solid var(--grey); border-radius: 12px; background: var(--light); cursor: pointer; transition: all 0.3s ease; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 8px; min-height: 100px;">
                            <div style="font-size: 32px; color: {{ cat.couleur }};">
                                {% if cat.icone|slice:":2" == "bx" %}
                                    <i class='{{ cat.icone }}'></i>
                                {% else %}
                                    <i class='bi {{ cat.icone }}'></i>
                                {% endif %}
                            </div>
                            <div style="font-weight: 600; color: var(--dark); font-size: 13px; line-height: 1.3;">{{ cat.nom }}</div>
                        </button>
                        {% endfor %}
                        <button type="button" class="categorie-card" 
                                data-categorie-id="autre"
                                data-categorie-nom="Autres"
                                onclick="selectCategorie('autre', 'Autres', 'bx-category', 'var(--dark-grey)')"
                                style="padding: 16px; border: 2px solid var(--grey); border-radius: 12px; background: var(--light); cursor: pointer; transition: all 0.3s ease; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 8px; min-height: 100px;">
                            <div style="font-size: 32px; color: var(--dark-grey);">
                                <i class='bx bx-category'></i>
                            </div>
                            <div style="font-weight: 600; color: var(--dark); font-size: 13px; line-height: 1.3;">Autres</div>
                        </button>
                    </div>
                    {% endif %}
                    
                    <!-- Select cach√© pour la soumission du formulaire -->
                    <select id="categorie_principale" name="categorie_principale" required onchange="loadSousCategories()" {% if depense_preview %}disabled{% endif %} style="{% if not depense_preview %}display: none;{% endif %}">
                        <option value="">-- S√©lectionner une cat√©gorie --</option>
                        {% for cat in categories_principales %}
                            <option value="{{ cat.id }}" data-icon="{{ cat.icone }}" {% if depense_preview and depense_preview.categorie_id == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.nom }}</option>
                        {% endfor %}
                        <option value="autre" {% if depense_preview and depense_preview.categorie_id == "autre" %}selected{% endif %}>Autres</option>
                    </select>
                    {% if depense_preview %}
                    <input type="hidden" name="categorie_principale" value="{{ depense_preview.categorie_id }}">
                    {% endif %}
                    
                    <!-- Affichage de la cat√©gorie s√©lectionn√©e -->
                    <div id="selected_categorie_display" style="{% if not depense_preview %}display: none;{% endif %} padding: 12px; background: var(--light-primary); border-radius: 8px; border-left: 4px solid var(--primary); margin-top: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="selected_categorie_icon" style="font-size: 20px;">
                                {% if depense_preview %}
                                    {% for cat in categories_principales %}
                                        {% if depense_preview.categorie_id == cat.id|stringformat:"s" %}
                                            {% if cat.icone|slice:":2" == "bx" %}
                                                <i class='{{ cat.icone }}'></i>
                                            {% else %}
                                                <i class='bi {{ cat.icone }}'></i>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </span>
                            <span id="selected_categorie_nom" style="font-weight: 600; color: var(--dark);">
                                {% if depense_preview %}
                                    {% for cat in categories_principales %}
                                        {% if depense_preview.categorie_id == cat.id|stringformat:"s" %}{{ cat.nom }}{% endif %}
                                    {% endfor %}
                                {% endif %}
                            </span>
                            {% if not depense_preview %}
                            <button type="button" onclick="clearCategorieSelection()" style="margin-left: auto; background: none; border: none; color: var(--danger); cursor: pointer; font-size: 18px;">
                                <i class='bx bx-x'></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div id="sous_categorie_container" style="display: none;">
                    <label for="sous_categorie" style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500; display: flex; align-items: center; gap: 4px;">
                        <i class='bx bx-folder'></i>üìÇ Sous-Cat√©gorie
                    </label>
                    <select id="sous_categorie" name="sous_categorie"
                            style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                        <option value="">-- S√©lectionner une sous-cat√©gorie (optionnel) --</option>
                    </select>
                </div>

                <input type="hidden" id="categorie" name="categorie" required>

                <div>
                    <label for="date_depense" style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500; display: flex; align-items: center; gap: 4px;">
                        <i class='bx bx-calendar'></i>üìÖ Date
                    </label>
                    <input type="date" id="date_depense" name="date_depense" min="" max="" value="{% if depense_preview %}{{ depense_preview.date_depense }}{% endif %}" {% if depense_preview %}readonly{% endif %} required
                           style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                    <small style="color: var(--dark-grey); font-size: 12px;">Date entre 1 mois avant aujourd'hui et 2 ans maximum</small>
                </div>

                <div>
                    <label for="notes" style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500; display: flex; align-items: center; gap: 4px;">
                        <i class='bx bx-note'></i>üìã Notes (optionnel)
                    </label>
                    <textarea id="notes" name="notes" rows="3" 
                              placeholder="Ajouter des notes..." {% if depense_preview %}readonly{% endif %}
                              style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none; resize: vertical;">{% if depense_preview %}{{ depense_preview.notes }}{% endif %}</textarea>
                </div>

                {% if alertes_avant_ajout %}
                <div class="card-dashboard" style="background: var(--light-warning); padding: 16px; border-radius: 8px; border-left: 4px solid var(--warning);">
                    <i class='bx bx-error-circle' style="color: var(--warning); margin-right: 8px;"></i>
                    <strong style="color: var(--dark);">‚ö†Ô∏è Attention :</strong> Cette d√©pense pourrait affecter vos budgets. 
                    V√©rifiez les alertes ci-dessus avant de continuer.
                </div>
                {% endif %}
                
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button type="submit" {% if alertes_avant_ajout %}name="confirmer_depassement" value="1"{% endif %}
                            style="flex: 1; min-width: 200px; padding: 12px 24px; background: var(--primary); color: var(--light); border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease; font-weight: 500;">
                        <i class='bx bx-check-circle'></i>
                        {% if alertes_avant_ajout %}
                            ‚ö†Ô∏è Confirmer l'ajout malgr√© les alertes
                        {% else %}
                            ‚úÖ Ajouter D√©pense
                        {% endif %}
                    </button>
                    <a href="{% url 'budget_foyer' %}" style="flex: 1; min-width: 150px; padding: 12px 24px; background: var(--grey); color: var(--dark); border-radius: 8px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease; font-weight: 500;">
                        <i class='bx bx-x-circle'></i>‚ùå Annuler
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    const categoriesData = {
        {% for cat in categories_principales %}
        {{ cat.id }}: [
            {% for sous_cat in cat.sous_categories.all %}
            {id: {{ sous_cat.id }}, nom: "{{ sous_cat.nom }}"}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]{% if not forloop.last %},{% endif %}
        {% endfor %}
    };

    function loadSousCategories() {
        const categoriePrincipaleId = document.getElementById('categorie_principale').value;
        const sousCategorieContainer = document.getElementById('sous_categorie_container');
        const sousCategorieSelect = document.getElementById('sous_categorie');
        const categorieFinale = document.getElementById('categorie');

        sousCategorieSelect.innerHTML = '<option value="">-- S√©lectionner une sous-cat√©gorie (optionnel) --</option>';

        if (categoriePrincipaleId === 'autre') {
            sousCategorieContainer.style.display = 'none';
            categorieFinale.value = '';
            return;
        }

        if (categoriePrincipaleId && categoriesData[categoriePrincipaleId] && categoriesData[categoriePrincipaleId].length > 0) {
            sousCategorieContainer.style.display = 'block';
            categoriesData[categoriePrincipaleId].forEach(function(sousCat) {
                const option = document.createElement('option');
                option.value = sousCat.id;
                option.textContent = sousCat.nom;
                sousCategorieSelect.appendChild(option);
            });
            categorieFinale.value = categoriePrincipaleId;
        } else {
            sousCategorieContainer.style.display = 'none';
            categorieFinale.value = categoriePrincipaleId;
        }
    }

    document.getElementById('sous_categorie').addEventListener('change', function() {
        const sousCategorieId = this.value;
        const categorieFinale = document.getElementById('categorie');
        if (sousCategorieId) {
            categorieFinale.value = sousCategorieId;
        } else {
            categorieFinale.value = document.getElementById('categorie_principale').value;
        }
    });

    // D√©finir les contraintes de date (1 mois avant, 2 ans apr√®s)
    const today = new Date();
    const minDate = new Date();
    minDate.setMonth(today.getMonth() - 1);
    const maxDate = new Date();
    maxDate.setFullYear(today.getFullYear() + 2);
    
    const dateInput = document.getElementById('date_depense');
    dateInput.min = minDate.toISOString().split('T')[0];
    dateInput.max = maxDate.toISOString().split('T')[0];
    
    // D√©finir la date d'aujourd'hui par d√©faut
    if (!dateInput.value) {
        dateInput.valueAsDate = new Date();
    }

    function selectCategorie(categorieId, categorieNom, categorieIcon, categorieCouleur) {
        // Mettre √† jour le select
        const select = document.getElementById('categorie_principale');
        select.value = categorieId;
        
        // Mettre √† jour l'affichage
        const display = document.getElementById('selected_categorie_display');
        const iconSpan = document.getElementById('selected_categorie_icon');
        const nomSpan = document.getElementById('selected_categorie_nom');
        
        // D√©terminer l'ic√¥ne
        let iconClass = categorieIcon;
        if (!iconClass.startsWith('bx') && !iconClass.startsWith('bi')) {
            iconClass = 'bx-category';
        }
        
        iconSpan.innerHTML = `<i class='${iconClass.startsWith("bx") ? iconClass : "bi " + iconClass}' style="color: ${categorieCouleur};"></i>`;
        nomSpan.textContent = categorieNom;
        display.style.display = 'block';
        
        // Mettre √† jour les cartes visuelles
        document.querySelectorAll('.categorie-card').forEach(card => {
            if (card.getAttribute('data-categorie-id') == categorieId) {
                card.style.border = '3px solid var(--primary)';
                card.style.background = 'var(--light-primary)';
                card.style.transform = 'scale(1.05)';
            } else {
                card.style.border = '2px solid var(--grey)';
                card.style.background = 'var(--light)';
                card.style.transform = 'scale(1)';
            }
        });
        
        // Charger les sous-cat√©gories
        loadSousCategories();
    }

    function clearCategorieSelection() {
        document.getElementById('categorie_principale').value = '';
        document.getElementById('selected_categorie_display').style.display = 'none';
        document.getElementById('sous_categorie_container').style.display = 'none';
        document.getElementById('categorie').value = '';
        
        // R√©initialiser les cartes
        document.querySelectorAll('.categorie-card').forEach(card => {
            card.style.border = '2px solid var(--grey)';
            card.style.background = 'var(--light)';
            card.style.transform = 'scale(1)';
        });
    }

    // Ajouter les styles hover pour les cartes
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.categorie-card').forEach(card => {
            card.addEventListener('mouseenter', function() {
                if (this.style.border !== '3px solid var(--primary)') {
                    this.style.border = '2px solid var(--primary)';
                    this.style.transform = 'scale(1.02)';
                }
            });
            card.addEventListener('mouseleave', function() {
                if (this.style.border !== '3px solid var(--primary)') {
                    this.style.border = '2px solid var(--grey)';
                    this.style.transform = 'scale(1)';
                }
            });
        });
    });
</script>
{% endblock %}
