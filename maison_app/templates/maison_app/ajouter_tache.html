{% extends "maison_app/dashboard_base.html" %}
{% load static %}
{% block page_title %}Ajouter une T√¢che{% endblock %}
{% block page_heading %}Ajouter une T√¢che{% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
    <li><a href="{% url 'dashboard' %}">Dashboard</a></li>
    /
    <li><a href="{% url 'liste_taches' %}">T√¢ches</a></li>
    /
    <li><a href="#" class="active">Ajouter une T√¢che</a></li>
</ul>
{% endblock %}

{% block page_content %}
<div class="card-dashboard" style="max-width: 800px; margin: 0 auto;">
    <div style="background: linear-gradient(135deg, var(--primary), var(--light-primary)); color: #FFFFFF; padding: 24px; border-radius: 12px 12px 0 0;">
        <h3 style="margin: 0; color: #FFFFFF !important; display: flex; align-items: center; gap: 12px; font-weight: 600;">
            <i class='bx bx-plus-circle' style="font-size: 28px; color: #FFFFFF;"></i>Nouvelle T√¢che
        </h3>
    </div>
    
    <div style="padding: 24px;">
        <!-- T√¢ches pr√©d√©finies (Accessibles √† tous) -->
        <div class="card-dashboard" style="background: var(--light-primary); padding: 20px; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid var(--primary);">
            <label style="display: block; margin-bottom: 12px; color: var(--dark); font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                <i class='bx bx-list-check' style="color: var(--primary);"></i>T√¢ches Pr√©d√©finies
            </label>
            <p style="color: var(--dark-grey); margin: 0 0 12px 0; font-size: 14px;">
                <i class='bx bx-info-circle' style="color: var(--primary);"></i>
                <strong>Astuce :</strong> S√©lectionnez une t√¢che pr√©d√©finie, puis ajoutez simplement la <strong>date</strong> et la <strong>personne assign√©e</strong> ! Vous pouvez aussi modifier d'autres d√©tails si vous le souhaitez.
            </p>
            <select id="tache_predefinie" onchange="chargerTachePredefinie()" style="width: 100%; padding: 12px; border: 2px solid var(--primary); border-radius: 8px; background: var(--light); color: var(--dark); outline: none; font-size: 15px;">
                <option value="">‚Äî Choisir une t√¢che pr√©d√©finie ‚Äî</option>
                {% for tache_predef in taches_predefinies %}
                <option value="{{ forloop.counter0 }}" 
                        data-titre="{{ tache_predef.titre }}"
                        data-description="{{ tache_predef.description }}"
                        data-piece-id="{{ tache_predef.piece_id|default:'' }}"
                        data-piece-nom="{{ tache_predef.piece_nom|default:'' }}">
                    {{ tache_predef.titre }}{% if tache_predef.piece_nom %} ({{ tache_predef.piece_nom }}){% endif %}
                </option>
                {% endfor %}
            </select>
        </div>
        <hr style="border: none; border-top: 1px solid var(--grey); margin: 24px 0;">
        
        <form method="post" id="form_tache" aria-label="Formulaire d'ajout de t√¢che">
            {% csrf_token %}
            <div style="display: grid; gap: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500;">Titre <span style="color: var(--danger);">*</span></label>
                    <input type="text" name="titre" id="titre" required oninput="mettreAJourSuggestions()"
                           style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500;">Description</label>
                    <textarea name="description" id="description" rows="3" oninput="mettreAJourSuggestions()"
                              style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none; resize: vertical;"></textarea>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500; display: flex; align-items: center; gap: 4px;">
                        <i class='bx bx-calendar-check'></i>Date limite <span id="date_required" style="color: var(--danger); display: none;">*</span>
                    </label>
                    <input type="date" name="date_limite" id="date_limite" min="" max=""
                           style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                    <small style="color: var(--dark-grey); font-size: 12px;">Date entre aujourd'hui et 2 ans maximum (optionnel, obligatoire avec t√¢che pr√©d√©finie)</small>
                </div>
                
                <script>
                    const today = new Date();
                    const maxDate = new Date();
                    maxDate.setFullYear(today.getFullYear() + 2);
                    const dateInput = document.getElementById('date_limite');
                    dateInput.min = today.toISOString().split('T')[0];
                    dateInput.max = maxDate.toISOString().split('T')[0];
                </script>
                
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500;">Priorit√©</label>
                    <select name="priorite" style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                        <option value="">‚Äî</option>
                        <option value="Haute">üî¥ Haute</option>
                        <option value="Moyenne">üü° Moyenne</option>
                        <option value="Basse">üü¢ Basse</option>
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500; display: flex; align-items: center; gap: 4px;">
                        <i class='bx bx-time'></i>Temps estim√© (optionnel)
                    </label>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" name="temps_estime" min="1" max="1440" placeholder="Ex: 30"
                               style="flex: 1; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                        <span style="padding: 12px; background: var(--grey); color: var(--dark); border-radius: 8px; display: flex; align-items: center;">minutes</span>
                    </div>
                    <small style="color: var(--dark-grey); font-size: 12px;">Estimez le temps n√©cessaire pour compl√©ter cette t√¢che</small>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500; display: flex; align-items: center; gap: 4px;">
                        <i class='bx bx-bell'></i>Rappel automatique (optionnel)
                    </label>
                    <input type="date" name="date_rappel" id="date_rappel" min="" max=""
                           style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                    <small style="color: var(--dark-grey); font-size: 12px;">Date √† laquelle vous recevrez une notification de rappel (1-2 jours avant la date limite recommand√©)</small>
                </div>
                
                <script>
                    const todayRappel = new Date();
                    const maxDateRappel = new Date();
                    maxDateRappel.setFullYear(todayRappel.getFullYear() + 2);
                    const dateRappelInput = document.getElementById('date_rappel');
                    if (dateRappelInput) {
                        dateRappelInput.min = todayRappel.toISOString().split('T')[0];
                        dateRappelInput.max = maxDateRappel.toISOString().split('T')[0];
                    }
                </script>
                
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500;">Pi√®ce</label>
                    <select name="id_piece" id="id_piece" style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                        <option value="">‚Äî Aucune pi√®ce ‚Äî</option>
                        {% for piece in pieces %}
                        <option value="{{ piece.id }}">{{ piece.nom }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500;">Animal (optionnel)</label>
                    <select name="id_animal" style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                        <option value="">‚Äî Aucun animal ‚Äî</option>
                        {% for animal in animaux %}
                        <option value="{{ animal.id }}">{{ animal.nom }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500; display: flex; align-items: center; gap: 4px;">
                        <i class='bx bx-user-check'></i>üë§ Assigner √† <span id="assignee_required" style="color: var(--danger); display: none;">*</span>
                    </label>
                    
                    <!-- Suggestions bas√©es sur les pr√©f√©rences -->
                    <div id="suggestions_preferences" style="display: none; background: var(--light-primary); padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid var(--success);">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class='bx bx-star' style="color: var(--success); font-size: 18px;"></i>
                            <strong style="color: var(--dark); font-size: 14px;">Suggestions bas√©es sur les pr√©f√©rences :</strong>
                        </div>
                        <div id="suggestions_list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <!-- Les suggestions seront ajout√©es ici dynamiquement -->
                        </div>
                        <small style="color: var(--dark-grey); font-size: 11px; display: block; margin-top: 8px;">
                            <i class='bx bx-info-circle'></i> Ces utilisateurs aiment ce type de t√¢che. Cliquez pour les s√©lectionner automatiquement.
                        </small>
                    </div>
                    
                    <select name="assignees" id="assignees" multiple size="5" style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                        {% for membre in membres %}
                        <option value="{{ membre.id }}" data-nom="{% if membre.nom %}{{ membre.nom }}{% else %}{{ membre.email }}{% endif %}">{% if membre.nom %}{{ membre.nom }}{% else %}{{ membre.email }}{% endif %}</option>
                        {% endfor %}
                    </select>
                    <small style="color: var(--dark-grey); font-size: 12px;">Maintenez Ctrl/Cmd pour s√©lectionner plusieurs membres (optionnel, obligatoire avec t√¢che pr√©d√©finie)</small>
                </div>
                
                <hr style="border: none; border-top: 1px solid var(--grey); margin: 24px 0;">
                
                <!-- T√¢ches r√©currentes -->
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500; display: flex; align-items: center; gap: 4px;">
                        <i class='bx bx-refresh'></i>T√¢che r√©currente (optionnel)
                    </label>
                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" name="est_recurrente" id="est_recurrente" onchange="toggleRecurrence()" style="width: 18px; height: 18px; cursor: pointer;">
                            <strong style="color: var(--dark);">Cr√©er une t√¢che r√©currente</strong>
                        </label>
                    </div>
                    <div id="recurrence_fields" style="display: none;">
                        <select name="frequence_recurrence" style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                            <option value="Quotidien">üìÖ Quotidienne (tous les jours)</option>
                            <option value="Hebdo">üìÜ Hebdomadaire (toutes les semaines)</option>
                            <option value="Mensuel">üóìÔ∏è Mensuelle (tous les mois)</option>
                        </select>
                        <small style="color: var(--dark-grey); font-size: 12px; display: block; margin-top: 8px;">
                            <i class='bx bx-info-circle'></i>
                            La t√¢che sera automatiquement recr√©√©e selon la fr√©quence choisie. Vous pourrez ensuite assigner chaque occurrence √† un membre.
                        </small>
                    </div>
                </div>
                
                <button type="submit" style="width: 100%; padding: 14px 24px; background: var(--primary); color: var(--light); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease;">
                    <i class='bx bx-plus-circle'></i>Ajouter la t√¢che
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function toggleRecurrence() {
    const checkbox = document.getElementById('est_recurrente');
    const fields = document.getElementById('recurrence_fields');
    if (checkbox.checked) {
        fields.style.display = 'block';
    } else {
        fields.style.display = 'none';
    }
}

// Donn√©es des suggestions pour les t√¢ches pr√©d√©finies
const suggestionsPredefinies = {
    {% for index, suggestions in suggestions_predefinies.items %}
    {{ index }}: [{% for user_id in suggestions %}{{ user_id }}{% if not forloop.last %}, {% endif %}{% endfor %}],
    {% endfor %}
};

// Pr√©f√©rences des membres
const preferencesMembres = {
    {% for membre_id, prefs in preferences_membres.items %}
    {{ membre_id }}: [{% for pref in prefs %}'{{ pref }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
    {% endfor %}
};

function mettreAJourSuggestions() {
    const titre = document.getElementById('titre').value.toLowerCase();
    const description = document.getElementById('description').value.toLowerCase();
    const texte = titre + ' ' + description;
    
    if (texte.trim().length < 3) {
        document.getElementById('suggestions_preferences').style.display = 'none';
        return;
    }
    
    // Mots-cl√©s pour chaque type de t√¢che (correspondant √† ceux du backend)
    const mots_cles_nettoyage = ['nettoyer', 'nettoyage', 'aspirateur', 'aspirer', 'lessive', 'laver', 'ranger', 'propre', 'salle de bain', 'douche', 'wc', 'toilette', 'vitre', 'fen√™tre', 'poubelle', 'sortir les poubelles', 'faire le lit', 'chambre'];
    const mots_cles_cuisine = ['cuisine', 'cuisiner', 'repas', 'd√Æner', 'd√©jeuner', 'pr√©parer', 'vaisselle', 'lave-vaisselle', 'cuire', 'four', 'plaque', 'manger'];
    const mots_cles_courses = ['courses', 'acheter', 'magasin', 'supermarch√©', '√©picerie', 'produits', 'aliments', 'nourriture', 'faire les courses'];
    const mots_cles_entretien = ['entretien', 'r√©parer', 'r√©paration', 'maintenance', 'jardin', 'plante', 'arroser', 'tondeuse', 'outil', 'jardinage'];
    
    // Compter les occurrences
    let score_nettoyage = mots_cles_nettoyage.filter(mot => texte.includes(mot)).length;
    let score_cuisine = mots_cles_cuisine.filter(mot => texte.includes(mot)).length;
    let score_courses = mots_cles_courses.filter(mot => texte.includes(mot)).length;
    let score_entretien = mots_cles_entretien.filter(mot => texte.includes(mot)).length;
    
    const scores = {
        'nettoyage': score_nettoyage,
        'cuisine': score_cuisine,
        'courses': score_courses,
        'entretien': score_entretien
    };
    
    const type_tache = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
    
    if (scores[type_tache] === 0) {
        document.getElementById('suggestions_preferences').style.display = 'none';
        return;
    }
    
    // Trouver les utilisateurs qui aiment ce type de t√¢che
    const suggestions = [];
    const assigneesSelect = document.getElementById('assignees');
    
    for (let option of assigneesSelect.options) {
        const membreId = parseInt(option.value);
        if (preferencesMembres[membreId] && preferencesMembres[membreId].includes(type_tache)) {
            suggestions.push({
                id: membreId,
                nom: option.getAttribute('data-nom') || option.text
            });
        }
    }
    
    afficherSuggestions(suggestions);
}

function afficherSuggestions(suggestions) {
    const container = document.getElementById('suggestions_preferences');
    const list = document.getElementById('suggestions_list');
    
    if (suggestions.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    list.innerHTML = '';
    
    suggestions.forEach(suggestion => {
        const badge = document.createElement('button');
        badge.type = 'button';
        badge.className = 'suggestion-badge';
        badge.style.cssText = 'padding: 6px 12px; background: var(--success); color: var(--light); border: none; border-radius: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease;';
        badge.innerHTML = `<i class='bx bx-user'></i>${suggestion.nom}`;
        badge.onclick = () => selectionnerUtilisateur(suggestion.id, badge);
        badge.onmouseover = () => badge.style.transform = 'scale(1.05)';
        badge.onmouseout = () => badge.style.transform = 'scale(1)';
        list.appendChild(badge);
    });
}

function selectionnerUtilisateur(membreId, badge) {
    const assigneesSelect = document.getElementById('assignees');
    const option = Array.from(assigneesSelect.options).find(opt => parseInt(opt.value) === membreId);
    
    if (option) {
        option.selected = true;
        badge.style.background = 'var(--primary)';
        badge.innerHTML = `<i class='bx bx-check'></i>${badge.textContent.replace(/^\S+\s/, '')}`;
        badge.onclick = () => deselectionnerUtilisateur(membreId, badge);
    }
}

function deselectionnerUtilisateur(membreId, badge) {
    const assigneesSelect = document.getElementById('assignees');
    const option = Array.from(assigneesSelect.options).find(opt => parseInt(opt.value) === membreId);
    
    if (option) {
        option.selected = false;
        badge.style.background = 'var(--success)';
        const nom = option.getAttribute('data-nom') || option.text;
        badge.innerHTML = `<i class='bx bx-user'></i>${nom}`;
        badge.onclick = () => selectionnerUtilisateur(membreId, badge);
    }
}

function chargerTachePredefinie() {
    const select = document.getElementById('tache_predefinie');
    const option = select.options[select.selectedIndex];
    const dateInput = document.getElementById('date_limite');
    const assigneesSelect = document.getElementById('assignees');
    const dateRequired = document.getElementById('date_required');
    const assigneeRequired = document.getElementById('assignee_required');
    
    if (option.value === '') {
        document.getElementById('titre').value = '';
        document.getElementById('description').value = '';
        document.getElementById('id_piece').value = '';
        document.getElementById('titre').style.backgroundColor = '';
        document.getElementById('description').style.backgroundColor = '';
        document.getElementById('id_piece').style.backgroundColor = '';
        dateInput.required = false;
        assigneesSelect.required = false;
        dateRequired.style.display = 'none';
        assigneeRequired.style.display = 'none';
        document.getElementById('suggestions_preferences').style.display = 'none';
        return;
    }
    
    const titre = option.getAttribute('data-titre');
    const description = option.getAttribute('data-description');
    const pieceId = option.getAttribute('data-piece-id');
    const index = parseInt(option.value);
    
    document.getElementById('titre').value = titre;
    document.getElementById('description').value = description;
    
    if (pieceId) {
        document.getElementById('id_piece').value = pieceId;
    }
    
    document.getElementById('titre').style.backgroundColor = '#e7f3ff';
    document.getElementById('description').style.backgroundColor = '#e7f3ff';
    if (pieceId) {
        document.getElementById('id_piece').style.backgroundColor = '#e7f3ff';
    }
    
    dateInput.required = true;
    assigneesSelect.required = true;
    dateRequired.style.display = 'inline';
    assigneeRequired.style.display = 'inline';
    
    // Afficher les suggestions pour cette t√¢che pr√©d√©finie
    if (suggestionsPredefinies[index] && suggestionsPredefinies[index].length > 0) {
        const suggestions = suggestionsPredefinies[index].map(id => {
            const option = Array.from(assigneesSelect.options).find(opt => parseInt(opt.value) === id);
            return {
                id: id,
                nom: option ? (option.getAttribute('data-nom') || option.text) : ''
            };
        }).filter(s => s.nom);
        afficherSuggestions(suggestions);
    } else {
        mettreAJourSuggestions();
    }
    
    setTimeout(() => {
        dateInput.focus();
    }, 100);
}
</script>
{% endblock %}
