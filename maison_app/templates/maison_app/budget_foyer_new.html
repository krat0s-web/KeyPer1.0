{% extends "maison_app/dashboard_base.html" %}
{% load static %}
{% load permission_tags %}

{% block title %}Budget & D√©penses{% endblock %}
{% block page_title %}Budget & D√©penses{% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
    <li><a href="{% url 'dashboard' %}">Dashboard</a></li> / <li><a href="#" class="active">Budget</a></li>
</ul>
{% endblock %}

{% block page_content %}
<div class="card-dashboard mb-4">
    <h3>üí∞ Budget & D√©penses</h3>
    <p><strong>Foyer:</strong> {{ foyer.nom }}</p>
    <p><strong>Total D√©penses:</strong> {{ total_depenses|floatformat:2 }}‚Ç¨</p>
    <p><strong>Total Budget:</strong> {{ total_budget|floatformat:2 }}‚Ç¨</p>
    
    {% if budget_depasse %}
    <div style="background: #ffcccc; padding: 15px; border-radius: 8px; margin: 15px 0;">
        <p><strong style="color: red;">‚ö†Ô∏è ALERTE: Budget d√©pass√© de {{ montant_depasse_global|floatformat:2 }}‚Ç¨!</strong></p>
    </div>
    {% else %}
    <div style="background: #ccffcc; padding: 15px; border-radius: 8px; margin: 15px 0;">
        <p><strong style="color: green;">‚úÖ Reste disponible: {{ reste_disponible|floatformat:2 }}‚Ç¨</strong></p>
    </div>
    {% endif %}
    
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0;">
        <div style="background: #667eea; color: white; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 12px;">Cette Semaine</div>
            <div id="depenses-semaine" style="font-size: 18px; font-weight: bold;">0‚Ç¨</div>
        </div>
        <div style="background: #f093fb; color: white; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 12px;">Ce Mois</div>
            <div id="depenses-mois" style="font-size: 18px; font-weight: bold;">0‚Ç¨</div>
        </div>
        <div style="background: #4facfe; color: white; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 12px;">Ce Trimestre</div>
            <div id="depenses-trimestre" style="font-size: 18px; font-weight: bold;">0‚Ç¨</div>
        </div>
        <div style="background: #43e97b; color: white; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 12px;">Cette Ann√©e</div>
            <div id="depenses-annee" style="font-size: 18px; font-weight: bold;">0‚Ç¨</div>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 30px;">
        <div style="border: 1px solid #ccc; padding: 15px; border-radius: 8px;">
            <h4>R√©partition par Cat√©gorie (30 jours)</h4>
            <canvas id="chart1" width="400" height="250"></canvas>
        </div>
        <div style="border: 1px solid #ccc; padding: 15px; border-radius: 8px;">
            <h4>√âvolution (6 mois)</h4>
            <canvas id="chart2" width="400" height="250"></canvas>
        </div>
    </div>
    
    <div style="border: 1px solid #ccc; padding: 15px; border-radius: 8px; margin-top: 20px;">
        <h4>Budget vs D√©penses par Cat√©gorie</h4>
        <canvas id="chart3" width="800" height="200"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script type="application/json" id="data-depenses">{{ depenses_par_categorie }}</script>
<script type="application/json" id="data-evolution">{{ evolution_depenses }}</script>
<script type="application/json" id="data-comparaison">{{ comparaison_budget_depenses }}</script>

<script>
console.log('‚úÖ Script charg√©');

// Afficher les p√©riodes
document.getElementById('depenses-semaine').textContent = ({{ depenses_semaine|default:0 }} || 0).toFixed(2) + '‚Ç¨';
document.getElementById('depenses-mois').textContent = ({{ depenses_mois|default:0 }} || 0).toFixed(2) + '‚Ç¨';
document.getElementById('depenses-trimestre').textContent = ({{ depenses_trimestre|default:0 }} || 0).toFixed(2) + '‚Ç¨';
document.getElementById('depenses-annee').textContent = ({{ depenses_annee|default:0 }} || 0).toFixed(2) + '‚Ç¨';

// Attendre que Chart soit charg√©
setTimeout(function() {
    if (typeof Chart === 'undefined') {
        console.error('‚ùå Chart.js non charg√©');
        return;
    }
    
    console.log('‚úÖ Chart.js disponible');
    
    // R√©cup√©rer les donn√©es
    const depensesScript = document.getElementById('data-depenses');
    const evolutionScript = document.getElementById('data-evolution');
    const comparaisonScript = document.getElementById('data-comparaison');
    
    let depensesData = {};
    let evolutionData = {};
    let comparaisonData = {};
    
    try {
        if (depensesScript && depensesScript.textContent) {
            depensesData = JSON.parse(depensesScript.textContent);
        }
    } catch (e) {
        console.error('Erreur d√©penses:', e);
    }
    
    try {
        if (evolutionScript && evolutionScript.textContent) {
            evolutionData = JSON.parse(evolutionScript.textContent);
        }
    } catch (e) {
        console.error('Erreur √©volution:', e);
    }
    
    try {
        if (comparaisonScript && comparaisonScript.textContent) {
            comparaisonData = JSON.parse(comparaisonScript.textContent);
        }
    } catch (e) {
        console.error('Erreur comparaison:', e);
    }
    
    console.log('üìä Donn√©es:', { depensesData, evolutionData, comparaisonData });
    
    // Graphique 1: D√©penses par cat√©gorie
    if (Object.keys(depensesData).length > 0) {
        const labels = Object.keys(depensesData);
        const values = Object.values(depensesData);
        
        new Chart(document.getElementById('chart1'), {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#43e97b', '#f093fb', '#667eea']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true
            }
        });
        console.log('‚úÖ Graphique 1 cr√©√©');
    }
    
    // Graphique 2: √âvolution
    if (Object.keys(evolutionData).length > 0) {
        const labels = Object.keys(evolutionData);
        const values = Object.values(evolutionData);
        
        new Chart(document.getElementById('chart2'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'D√©penses (‚Ç¨)',
                    data: values,
                    borderColor: '#36A2EB',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: true }
                }
            }
        });
        console.log('‚úÖ Graphique 2 cr√©√©');
    }
    
    // Graphique 3: Comparaison budget/d√©penses
    if (Object.keys(comparaisonData).length > 0) {
        const labels = Object.keys(comparaisonData);
        const budgets = labels.map(k => comparaisonData[k].budget || 0);
        const depenses = labels.map(k => comparaisonData[k].depenses || 0);
        
        new Chart(document.getElementById('chart3'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Budget',
                        data: budgets,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)'
                    },
                    {
                        label: 'D√©penses',
                        data: depenses,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
        console.log('‚úÖ Graphique 3 cr√©√©');
    }
    
    console.log('üéâ Tous les graphiques initialis√©s');
}, 1000);
</script>

{% endblock %}
