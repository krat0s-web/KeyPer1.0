{% extends "maison_app/dashboard_base.html" %}
{% load static %}
{% load permission_tags %}
{% block title %}Calendrier des Tâches{% endblock %}
{% block page_title %}Calendrier des Tâches{% endblock %}
{% block page_heading %}Calendrier{% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
    <li><a href="{% url 'dashboard' %}">Dashboard</a></li>
    /
    <li><a href="{% url 'liste_taches' %}">Tâches</a></li>
    /
    <li><a href="#" class="active">Calendrier</a></li>
</ul>
{% endblock %}

{% block page_content %}
<div class="card-dashboard mb-4">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px;">
        <h3 style="color: var(--dark); display: flex; align-items: center; gap: 12px;">
            <i class='bx bx-calendar' style="font-size: 28px; color: var(--primary);"></i>Calendrier des Tâches
        </h3>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <a href="{% url 'calendrier_taches' %}?mois={{ mois_precedent }}&annee={{ annee_precedente }}" style="padding: 8px 16px; background: var(--grey); color: var(--dark); border-radius: 8px; display: flex; align-items: center; gap: 8px; text-decoration: none; transition: all 0.3s ease;">
                <i class='bx bx-chevron-left'></i>Mois précédent
            </a>
            <a href="{% url 'calendrier_taches' %}?mois={{ mois_suivant }}&annee={{ annee_suivante }}" style="padding: 8px 16px; background: var(--grey); color: var(--dark); border-radius: 8px; display: flex; align-items: center; gap: 8px; text-decoration: none; transition: all 0.3s ease;">
                Mois suivant<i class='bx bx-chevron-right'></i>
            </a>
            {% load permission_tags %}
            {% if user|can:"can_add_evenement" %}
            <a href="{% url 'ajouter_evenement' %}" style="padding: 8px 16px; background: var(--warning); color: var(--dark); border-radius: 8px; display: flex; align-items: center; gap: 8px; text-decoration: none; transition: all 0.3s ease; font-weight: 500;">
                <i class='bx bx-plus-circle'></i>Ajouter un événement
            </a>
            {% endif %}
            <a href="{% url 'liste_taches' %}" style="padding: 8px 16px; background: var(--primary); color: var(--light); border-radius: 8px; display: flex; align-items: center; gap: 8px; text-decoration: none; transition: all 0.3s ease;">
                <i class='bx bx-list-ul'></i>Vue liste
            </a>
        </div>
    </div>
    
    <div style="background: var(--light); border-radius: 12px; overflow: hidden; margin-bottom: 24px;">
        <div style="background: var(--primary); color: #FFFFFF; padding: 20px; text-align: center;">
            <h3 style="margin: 0; color: #FFFFFF !important; font-weight: 600;">{{ noms_mois|slice:mois|last }} {{ annee }}</h3>
        </div>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
                <thead style="background: var(--grey);">
                    <tr>
                        <th style="padding: 12px; text-align: center; color: var(--dark); font-weight: 600; width: 14.28%; border: 1px solid var(--grey);">Lun</th>
                        <th style="padding: 12px; text-align: center; color: var(--dark); font-weight: 600; width: 14.28%; border: 1px solid var(--grey);">Mar</th>
                        <th style="padding: 12px; text-align: center; color: var(--dark); font-weight: 600; width: 14.28%; border: 1px solid var(--grey);">Mer</th>
                        <th style="padding: 12px; text-align: center; color: var(--dark); font-weight: 600; width: 14.28%; border: 1px solid var(--grey);">Jeu</th>
                        <th style="padding: 12px; text-align: center; color: var(--dark); font-weight: 600; width: 14.28%; border: 1px solid var(--grey);">Ven</th>
                        <th style="padding: 12px; text-align: center; color: var(--dark); font-weight: 600; width: 14.28%; border: 1px solid var(--grey);">Sam</th>
                        <th style="padding: 12px; text-align: center; color: var(--dark); font-weight: 600; width: 14.28%; border: 1px solid var(--grey);">Dim</th>
                    </tr>
                </thead>
                <tbody>
                    {% for semaine in semaines %}
                    <tr>
                        {% for jour in semaine %}
                        <td style="height: 120px; vertical-align: top; padding: 8px; border: 1px solid var(--grey); {% if jour.est_du_mois == False %}background: var(--grey); opacity: 0.5;{% elif jour.date == today %}background: var(--light-primary);{% elif jour.date < today and jour.est_du_mois %}background: var(--grey);{% else %}background: var(--light);{% endif %}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="{% if jour.date == today %}color: var(--primary);{% elif jour.est_du_mois == False %}color: var(--dark-grey);{% elif jour.date < today %}color: var(--dark-grey);{% else %}color: var(--dark);{% endif %}">
                                    {{ jour.numero }}
                                </strong>
                                {% if jour.date == today %}
                                <span style="padding: 2px 8px; background: var(--primary); color: #FFFFFF !important; border-radius: 12px; font-size: 10px; font-weight: 500;">Aujourd'hui</span>
                                {% endif %}
                            </div>
                            {% if jour.est_du_mois %}
                            <div style="max-height: 80px; overflow-y: auto;">
                                {% for evenement in jour.evenements %}
                                <div style="margin-bottom: 4px;">
                                    {% if user.role == 'admin' %}
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <a href="{% url 'modifier_evenement' evenement.id %}" style="flex: 1; display: block; padding: 4px 8px; background: var(--card-purple); color: var(--dark); border-radius: 6px; font-size: 11px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; border-left: 3px solid var(--primary); font-weight: 500; text-decoration: none; transition: all 0.2s ease;"
                                           title="{{ evenement.titre }}{% if evenement.description %}: {{ evenement.description|truncatewords:10 }}{% endif %}"
                                           onmouseover="this.style.background='var(--light-primary)'; this.style.transform='scale(1.02)'"
                                           onmouseout="this.style.background='var(--card-purple)'; this.style.transform='scale(1)'">
                                            <i class='bx bx-calendar-event' style="font-size: 10px;"></i> {{ evenement.titre|truncatewords:3 }}
                                        </a>
                                    </div>
                                    {% else %}
                                    <div style="display: block; padding: 4px 8px; background: var(--card-purple); color: var(--dark); border-radius: 6px; font-size: 11px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; border-left: 3px solid var(--primary); font-weight: 500;"
                                       title="{{ evenement.titre }}{% if evenement.description %}: {{ evenement.description|truncatewords:10 }}{% endif %}">
                                        <i class='bx bx-calendar-event' style="font-size: 10px;"></i> {{ evenement.titre|truncatewords:3 }}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                                {% for tache in jour.taches %}
                                <div style="margin-bottom: 4px;">
                                    <a href="{% url 'detail_tache' tache.id %}" 
                                       style="display: block; padding: 4px 8px; background: {% if tache.terminee %}var(--success){% elif tache.priorite == 'Haute' %}var(--danger){% elif tache.priorite == 'Moyenne' %}var(--warning){% else %}var(--primary){% endif %}; color: {% if tache.terminee or tache.priorite == 'Haute' or tache.priorite == 'Basse' or not tache.priorite %}#FFFFFF{% else %}var(--dark){% endif %}; border-radius: 6px; text-decoration: {% if tache.terminee %}line-through{% else %}none{% endif %}; font-size: 11px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;"
                                       title="{{ tache.titre }}">
                                        {{ tache.titre|truncatewords:3 }}
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Légende -->
    <div class="card-dashboard">
        <h6 style="margin-bottom: 16px; color: var(--dark);">Légende :</h6>
        <div style="display: flex; flex-wrap: wrap; gap: 12px;">
            <span style="padding: 6px 12px; background: var(--card-purple); color: var(--dark); border-radius: 12px; font-size: 12px; border-left: 3px solid var(--primary);"><i class='bx bx-calendar-event'></i> Événement</span>
            <span style="padding: 6px 12px; background: var(--danger); color: var(--light); border-radius: 12px; font-size: 12px;">Priorité Haute</span>
            <span style="padding: 6px 12px; background: var(--warning); color: var(--dark); border-radius: 12px; font-size: 12px;">Priorité Moyenne</span>
            <span style="padding: 6px 12px; background: var(--primary); color: #FFFFFF !important; border-radius: 12px; font-size: 12px;">Priorité Basse</span>
            <span style="padding: 6px 12px; background: var(--success); color: var(--light); border-radius: 12px; font-size: 12px;">Tâche Terminée</span>
            <span style="padding: 6px 12px; background: var(--light-primary); color: var(--primary); border-radius: 12px; font-size: 12px;">Aujourd'hui</span>
        </div>
    </div>
</div>

<style>
    .taches-jour::-webkit-scrollbar {
        width: 4px;
    }
    .taches-jour::-webkit-scrollbar-thumb {
        background: var(--grey);
        border-radius: 2px;
    }
</style>
{% endblock %}
