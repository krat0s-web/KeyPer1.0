{% extends "maison_app/dashboard_base.html" %}
{% load static %}
{% block title %}Menu semaine du {{ menu.semaine_debut|date:"d/m/Y" }} - {{ piece.nom }}{% endblock %}
{% block page_title %}Menu semaine du {{ menu.semaine_debut|date:"d/m/Y" }}{% endblock %}
{% block page_heading %}Menu semaine du {{ menu.semaine_debut|date:"d/m/Y" }}{% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
    <li><a href="{% url 'dashboard' %}">Dashboard</a></li>
    /
    <li><a href="{% url 'cuisine_view' piece.id %}">Cuisine</a></li>
    /
    <li><a href="{% url 'menus_semaine' piece.id %}">Menus</a></li>
    /
    <li><a href="#" class="active">Menu semaine du {{ menu.semaine_debut|date:"d/m/Y" }}</a></li>
</ul>
{% endblock %}

{% block page_content %}
<div class="card-dashboard" style="padding: 0; overflow: hidden;">
    <div style="background: linear-gradient(135deg, var(--warning), var(--danger)); color: var(--light); padding: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
        <h3 style="margin: 0; color: var(--light); display: flex; align-items: center; gap: 12px;">
            <i class='bx bx-calendar-week' style="font-size: 28px;"></i>Menu semaine du {{ menu.semaine_debut|date:"d/m/Y" }}
        </h3>
        <a href="{% url 'menus_semaine' piece.id %}" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: var(--light); border-radius: 8px; text-decoration: none; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;">
            <i class='bx bx-arrow-back'></i>Retour
        </a>
    </div>
    
    <div style="padding: 24px;">
        <!-- Ajouter un repas -->
        {% if user.role != 'observateur' %}
        <div class="card-dashboard" style="margin-bottom: 24px; border-left: 4px solid var(--warning);">
            <h5 style="margin: 0 0 16px 0; color: var(--dark); display: flex; align-items: center; gap: 8px;">
                <i class='bx bx-plus-circle' style="color: var(--warning);"></i>Ajouter un repas
            </h5>
            <form method="post" style="display: grid; grid-template-columns: 1fr 1fr 2fr auto; gap: 12px; align-items: end;">
                {% csrf_token %}
                <input type="hidden" name="action" value="ajouter_repas">
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500;">Jour</label>
                    <select name="jour" required style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                        <option value="">-- Jour --</option>
                        {% for jour_code, jour_nom in jours_semaine %}
                        <option value="{{ jour_code }}">{{ jour_nom }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500;">Type</label>
                    <select name="type_repas" required style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                        <option value="petit_dejeuner">Petit-déjeuner</option>
                        <option value="dejeuner">Déjeuner</option>
                        <option value="diner">Dîner</option>
                        <option value="collation">Collation</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500;">Nom du repas</label>
                    <input type="text" name="nom_repas" placeholder="Nom du repas" required
                           style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                </div>
                <button type="submit" style="padding: 12px 24px; background: var(--warning); color: var(--dark); border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; white-space: nowrap;">
                    <i class='bx bx-plus'></i>Ajouter
                </button>
            </form>
        </div>
        {% else %}
        <div style="background: var(--light-warning); color: var(--dark); padding: 16px; border-radius: 8px; margin-bottom: 24px; text-align: center; border-left: 4px solid var(--warning);">
            <i class='bx bx-info-circle' style="font-size: 20px; margin-right: 8px;"></i> Mode observateur : Accès en lecture seule. Vous ne pouvez pas modifier les menus.
        </div>
        {% endif %}

        <!-- Plats prédéfinis -->
        {% if user.role != 'observateur' %}
        <div class="card-dashboard" style="margin-bottom: 24px; border-left: 4px solid var(--primary);">
            <h5 style="margin: 0 0 16px 0; color: var(--dark); display: flex; align-items: center; gap: 8px;">
                <i class='bx bx-list-check' style="color: var(--primary);"></i>Plats suggérés
            </h5>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                {% for type_repas, plats in plats_predfinis.items %}
                <div>
                    <h6 style="color: var(--dark-grey); margin-bottom: 8px; font-size: 14px; font-weight: 600;">{{ type_repas }}</h6>
                    <div style="border: 1px solid var(--grey); border-radius: 8px; padding: 12px; max-height: 200px; overflow-y: auto; background: var(--light);">
                        {% for plat in plats %}
                        <form method="post" style="display: inline-block; margin: 4px;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="ajouter_repas">
                            <input type="hidden" name="nom_repas" value="{{ plat }}">
                            <input type="hidden" name="type_repas" value="{% if type_repas == 'Petit-déjeuner' %}petit_dejeuner{% elif type_repas == 'Déjeuner' %}dejeuner{% elif type_repas == 'Dîner' %}diner{% else %}collation{% endif %}">
                            <select name="jour" required style="padding: 6px 8px; border: 1px solid var(--grey); border-radius: 6px; background: var(--light); color: var(--dark); font-size: 12px; margin-right: 4px;">
                                <option value="">Jour</option>
                                {% for jour_code, jour_nom in jours_semaine %}
                                <option value="{{ jour_code }}">{{ jour_nom }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" style="padding: 6px 12px; background: var(--primary); color: var(--light); border: none; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.3s ease;">
                                {{ plat }}
                            </button>
                        </form>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <hr style="border: none; border-top: 1px solid var(--grey); margin: 24px 0;">

        <!-- Liste des repas par jour -->
        <h4 style="margin: 0 0 16px 0; color: var(--dark); display: flex; align-items: center; gap: 8px;">
            <i class='bx bx-list-ul' style="color: var(--primary);"></i>Repas de la semaine
        </h4>
        {% if repas %}
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
            {% for jour_code, jour_nom in jours_semaine %}
            <div class="card-dashboard" style="border-left: 4px solid var(--warning);">
                <h6 style="margin: 0 0 12px 0; color: var(--dark); font-weight: 600; padding-bottom: 8px; border-bottom: 1px solid var(--grey);">
                    {{ jour_nom }}
                </h6>
                <div>
                    {% for r in repas %}
                        {% if r.jour == jour_code %}
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 8px; background: var(--light-primary); border-radius: 6px;">
                            <div>
                                <span style="padding: 4px 8px; background: var(--primary); color: #ffffff; border-radius: 12px; font-size: 11px; margin-right: 8px; font-weight: 600;">
                                    {{ r.get_type_repas_display }}
                                </span>
                                <span style="color: var(--dark); font-weight: 500;">{{ r.nom }}</span>
                            </div>
                            {% if user.role != 'observateur' %}
                            <form method="post" style="display: inline;" onsubmit="return confirm('Supprimer ce repas ?');">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="supprimer_repas">
                                <input type="hidden" name="repas_id" value="{{ r.id }}">
                                <button type="submit" style="padding: 4px 8px; background: var(--danger); color: var(--light); border: none; border-radius: 6px; cursor: pointer;">
                                    <i class='bx bx-trash'></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                    {% if not repas|length %}
                    <p style="color: var(--dark-grey); font-size: 14px; margin: 0;">Aucun repas</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="card-dashboard" style="text-align: center; padding: 48px; background: var(--light-primary);">
            <i class='bx bx-info-circle' style="font-size: 3rem; margin-bottom: 16px; display: block; color: var(--primary); opacity: 0.5;"></i>
            <p style="margin: 0; color: var(--dark);">Aucun repas ajouté pour cette semaine. Ajoutez des repas ci-dessus.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
