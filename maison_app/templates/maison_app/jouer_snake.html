{% extends "maison_app/dashboard_base.html" %}
{% load static %}
{% block title %}Jeu Snake - Niveau {{ niveau.numero }}{% endblock %}
{% block page_title %}Jeu Snake - Niveau {{ niveau.numero }}{% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
    <li><a href="{% url 'dashboard' %}">Dashboard</a></li>
    /
    <li><a href="{% url 'detail_foyer' piece.id_foyer.id %}">Foyer</a></li>
    /
    <li><a href="{% url 'detail_piece' piece.id %}">{{ piece.nom }}</a></li>
    /
    <li><a href="{% url 'liste_niveaux_snake' piece.id %}">Snake</a></li>
    /
    <li><a href="#" class="active">Niveau {{ niveau.numero }}</a></li>
</ul>
{% endblock %}

{% block page_content %}
<div class="card-dashboard mb-4">
    <div style="background: linear-gradient(135deg, var(--primary), var(--light-primary)); color: #FFFFFF; padding: 24px; border-radius: 12px 12px 0 0; margin: -24px -24px 24px -24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
        <div>
            <h3 style="margin: 0; color: #FFFFFF !important; display: flex; align-items: center; gap: 12px; font-weight: 600;">
                <i class='bx bx-game' style="font-size: 32px;"></i>Snake - Niveau {{ niveau.numero }}
            </h3>
            <p style="margin: 8px 0 0 0; color: rgba(255,255,255,0.9);">{{ niveau.nom }}</p>
        </div>
        <a href="{% url 'liste_niveaux_snake' piece.id %}" style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: #FFFFFF; border-radius: 8px; text-decoration: none; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;">
            <i class='bx bx-arrow-back'></i> Retour
        </a>
    </div>
    
    <div style="padding: 24px;">
        <style>
            @media screen and (max-width: 968px) {
                .game-layout {
                    grid-template-columns: 1fr !important;
                }
            }
        </style>
        <div class="game-layout" style="display: grid; grid-template-columns: 1fr 300px; gap: 24px; margin-bottom: 24px;">
            <!-- Zone de jeu -->
            <div style="background: var(--grey); border-radius: 12px; padding: 20px; text-align: center;">
                <div id="game-container" style="position: relative; display: inline-block; max-width: 100%;">
                    <canvas id="gameCanvas" width="600" height="600" style="
                        border: 3px solid var(--primary);
                        border-radius: 8px;
                        background: #1a1a2e;
                        display: block;
                        margin: 0 auto;
                        max-width: 100%;
                        height: auto;
                    "></canvas>
                    <div id="game-over" style="
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0,0,0,0.9);
                        color: #FFFFFF;
                        padding: 32px;
                        border-radius: 16px;
                        text-align: center;
                        display: none;
                        z-index: 1000;
                    ">
                        <h3 style="margin: 0 0 16px 0; color: #FFFFFF;">Game Over!</h3>
                        <p id="final-score" style="font-size: 24px; margin: 0 0 24px 0; color: var(--warning);"></p>
                        <button onclick="restartGame()" style="
                            padding: 12px 24px;
                            background: var(--primary);
                            color: #FFFFFF;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            margin-right: 8px;
                        ">Rejouer</button>
                        <a href="{% url 'liste_niveaux_snake' piece.id %}" style="
                            padding: 12px 24px;
                            background: var(--grey);
                            color: var(--dark);
                            border-radius: 8px;
                            text-decoration: none;
                            font-weight: 600;
                            display: inline-block;
                        ">Retour</a>
                    </div>
                </div>
            </div>
            
            <!-- Panneau de contr√¥le -->
            <div>
                <div class="card-dashboard" style="margin-bottom: 16px;">
                    <h5 style="margin: 0 0 16px 0; color: var(--dark);">Score</h5>
                    <div id="score-display" style="font-size: 32px; font-weight: 700; color: var(--primary); text-align: center;">
                        0
                    </div>
                    {% if niveau_debloque.meilleur_score > 0 %}
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--grey);">
                        <small style="color: var(--dark-grey);">Meilleur score:</small>
                        <div style="font-size: 20px; font-weight: 600; color: var(--success);">
                            {{ niveau_debloque.meilleur_score }}
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="card-dashboard">
                    <h5 style="margin: 0 0 16px 0; color: var(--dark);">Contr√¥les</h5>
                    <div style="font-size: 14px; color: var(--dark-grey); line-height: 1.8;">
                        <div><i class='bx bx-up-arrow-alt'></i> Fl√®che Haut</div>
                        <div><i class='bx bx-down-arrow-alt'></i> Fl√®che Bas</div>
                        <div><i class='bx bx-left-arrow-alt'></i> Fl√®che Gauche</div>
                        <div><i class='bx bx-right-arrow-alt'></i> Fl√®che Droite</div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--grey);">
                            <strong>Espace</strong> : Pause/Reprendre
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Configuration du jeu
const config = {
    vitesse: {{ niveau.vitesse }},
    niveauId: {{ niveau.id }},
    pieceId: {{ piece.id }},
    scoreRequis: {{ niveau.score_requis }},
    csrfToken: '{{ csrf_token }}'
};

// Jeu Snake
let canvas = document.getElementById('gameCanvas');
let ctx = canvas.getContext('2d');
let gridSize = 20;
let tileCount = canvas.width / gridSize;

let snake = [{x: 10, y: 10}];
let velocity = {x: 0, y: 0};
let food = {x: 15, y: 15};
let score = 0;
let gameRunning = true;
let gamePaused = false;

function drawGame() {
    clearCanvas();
    drawSnake();
    drawFood();
    updateScore();
}

function clearCanvas() {
    ctx.fillStyle = '#1a1a2e';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
}

function drawSnake() {
    ctx.fillStyle = '#4CAF50';
    for (let segment of snake) {
        ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 2, gridSize - 2);
    }
    
    // T√™te du serpent
    ctx.fillStyle = '#66BB6A';
    ctx.fillRect(snake[0].x * gridSize, snake[0].y * gridSize, gridSize - 2, gridSize - 2);
}

function drawFood() {
    ctx.fillStyle = '#F44336';
    ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 2, gridSize - 2);
}

function moveSnake() {
    if (!gameRunning || gamePaused) return;
    
    const head = {x: snake[0].x + velocity.x, y: snake[0].y + velocity.y};
    
    // V√©rifier les collisions avec les murs
    if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
        gameOver();
        return;
    }
    
    // V√©rifier les collisions avec soi-m√™me (sauf la t√™te actuelle)
    for (let i = 0; i < snake.length; i++) {
        if (head.x === snake[i].x && head.y === snake[i].y) {
            gameOver();
            return;
        }
    }
    
    snake.unshift(head);
    
    // V√©rifier si le serpent mange la nourriture
    if (head.x === food.x && head.y === food.y) {
        score += 10;
        generateFood();
    } else {
        snake.pop();
    }
}

function generateFood() {
    food = {
        x: Math.floor(Math.random() * tileCount),
        y: Math.floor(Math.random() * tileCount)
    };
    
    // V√©rifier que la nourriture n'est pas sur le serpent
    for (let segment of snake) {
        if (food.x === segment.x && food.y === segment.y) {
            generateFood();
            return;
        }
    }
}

function updateScore() {
    document.getElementById('score-display').textContent = score;
}

function gameOver() {
    gameRunning = false;
    document.getElementById('game-over').style.display = 'block';
    document.getElementById('final-score').textContent = `Score: ${score}`;
    
    // Sauvegarder le score
    saveScore(score);
}

function saveScore(finalScore) {
    const formData = new FormData();
    formData.append('score', finalScore);
    formData.append('csrfmiddlewaretoken', config.csrfToken);
    
    fetch(`/piece/${config.pieceId}/snake/niveau/${config.niveauId}/score/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.score_ameliore) {
                alert(`üéâ Nouveau record ! Score: ${finalScore}`);
            }
            if (data.points_gagnes > 0) {
                alert(`‚úÖ Vous avez gagn√© ${data.points_gagnes} points !`);
            }
        }
    })
    .catch(error => console.error('Erreur:', error));
}

function restartGame() {
    snake = [{x: 10, y: 10}];
    velocity = {x: 0, y: 0};
    score = 0;
    gameRunning = true;
    gamePaused = false;
    generateFood();
    document.getElementById('game-over').style.display = 'none';
    updateScore();
}

// Contr√¥les clavier
document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
        e.preventDefault();
        gamePaused = !gamePaused;
        return;
    }
    
    if (!gameRunning || gamePaused) return;
    
    switch(e.key) {
        case 'ArrowUp':
            if (velocity.y === 0) velocity = {x: 0, y: -1};
            break;
        case 'ArrowDown':
            if (velocity.y === 0) velocity = {x: 0, y: 1};
            break;
        case 'ArrowLeft':
            if (velocity.x === 0) velocity = {x: -1, y: 0};
            break;
        case 'ArrowRight':
            if (velocity.x === 0) velocity = {x: 1, y: 0};
            break;
    }
});

// D√©marrer le jeu
generateFood();
setInterval(() => {
    if (gameRunning && !gamePaused) {
        moveSnake();
        drawGame();
    }
}, config.vitesse);

// Dessiner le jeu initial
drawGame();
</script>
{% endblock %}

