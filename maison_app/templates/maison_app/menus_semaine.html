{% extends "maison_app/dashboard_base.html" %}
{% load static %}
{% block title %}Menus de la Semaine - {{ piece.nom }}{% endblock %}
{% block page_title %}Menus de la Semaine - {{ piece.nom }}{% endblock %}
{% block page_heading %}Menus de la Semaine{% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
    <li><a href="{% url 'dashboard' %}">Dashboard</a></li>
    /
    <li><a href="{% url 'cuisine_view' piece.id %}">Cuisine</a></li>
    /
    <li><a href="#" class="active">Menus de la Semaine</a></li>
</ul>
{% endblock %}

{% block page_content %}
<div class="card-dashboard" style="padding: 0; overflow: hidden;">
    <div style="background: linear-gradient(135deg, var(--warning), var(--danger)); color: var(--light); padding: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
        <h3 style="margin: 0; color: var(--light); display: flex; align-items: center; gap: 12px;">
            <i class='bx bx-calendar-week' style="font-size: 28px;"></i>Menus de la Semaine
        </h3>
        <a href="{% url 'cuisine_view' piece.id %}" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: var(--light); border-radius: 8px; text-decoration: none; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;">
            <i class='bx bx-arrow-back'></i>Retour
        </a>
    </div>
    
    <div style="padding: 24px;">
        <!-- Créer un nouveau menu -->
        {% if user.role != 'observateur' %}
        <div class="card-dashboard" style="margin-bottom: 24px; border-left: 4px solid var(--warning);">
            <h5 style="margin: 0 0 16px 0; color: var(--dark); display: flex; align-items: center; gap: 8px;">
                <i class='bx bx-plus-circle' style="color: var(--warning);"></i>Créer un nouveau menu
            </h5>
            <form method="post" style="display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: end;">
                {% csrf_token %}
                <input type="hidden" name="action" value="creer_menu">
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500;">Semaine début (lundi)</label>
                    <input type="date" name="semaine_debut" style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;" required>
                    <small style="color: var(--dark-grey); font-size: 12px;">Sélectionnez le lundi de la semaine</small>
                </div>
                <button type="submit" style="padding: 12px 24px; background: var(--warning); color: var(--dark); border: none; border-radius: 8px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; white-space: nowrap;">
                    <i class='bx bx-plus-circle'></i>Créer le menu
                </button>
            </form>
        </div>
        {% else %}
        <div style="background: var(--light-warning); color: var(--dark); padding: 16px; border-radius: 8px; margin-bottom: 24px; text-align: center; border-left: 4px solid var(--warning);">
            <i class='bx bx-info-circle' style="font-size: 20px; margin-right: 8px;"></i> Mode observateur : Accès en lecture seule. Vous ne pouvez pas créer de menus.
        </div>
        {% endif %}

        <!-- Menus existants -->
        <div>
            <h4 style="margin: 0 0 16px 0; color: var(--dark); display: flex; align-items: center; gap: 8px;">
                <i class='bx bx-calendar' style="color: var(--primary);"></i>Menus existants
            </h4>
            {% if menus %}
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                {% for menu in menus %}
                <div class="card-dashboard" style="border-left: 4px solid var(--warning); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                    <h6 style="margin: 0 0 8px 0; color: var(--dark); font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <i class='bx bx-calendar-week' style="color: var(--warning);"></i>
                        Menu - Semaine du {{ menu.semaine_debut|date:"d/m/Y" }}
                    </h6>
                    <p style="color: var(--dark-grey); font-size: 14px; margin: 0 0 12px 0;">
                        Semaine du {{ menu.semaine_debut|date:"d/m/Y" }}
                    </p>
                    <p style="margin: 0 0 16px 0;">
                        <span style="padding: 4px 12px; background: var(--light-primary); color: var(--primary); border-radius: 12px; font-size: 12px; font-weight: 500;">
                            {{ menu.repas.count }} repas
                        </span>
                    </p>
                    <a href="{% url 'detail_menu_semaine' piece.id menu.id %}" style="padding: 8px 16px; background: var(--warning); color: var(--dark); border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; font-size: 14px; transition: all 0.3s ease;">
                        <i class='bx bx-show'></i>Voir / Modifier
                    </a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card-dashboard" style="text-align: center; padding: 48px; background: var(--light-primary);">
                <i class='bx bx-info-circle' style="font-size: 3rem; margin-bottom: 16px; display: block; color: var(--primary); opacity: 0.5;"></i>
                <p style="margin: 0; color: var(--dark);">Aucun menu créé pour le moment. Créez votre premier menu ci-dessus.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Pré-remplir avec le lundi de la semaine en cours
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.querySelector('input[name="semaine_debut"]');
    if (dateInput) {
        const today = new Date();
        const day = today.getDay();
        const diff = today.getDate() - day + (day === 0 ? -6 : 1); // Ajuster pour lundi
        const monday = new Date(today.setDate(diff));
        const mondayStr = monday.toISOString().split('T')[0];
        dateInput.value = mondayStr;
    }
});
</script>
{% endblock %}
