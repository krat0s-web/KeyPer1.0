{% extends "maison_app/dashboard_base.html" %}
{% load static %}
{% block title %}Mes Notes{% endblock %}
{% block page_title %}Mes Notes{% endblock %}
{% block page_heading %}Mes Notes{% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
    <li><a href="{% url 'dashboard' %}">Dashboard</a></li>
    /
    <li><a href="#" class="active">Mes Notes</a></li>
</ul>
{% endblock %}

{% block page_content %}
<div class="card-dashboard mb-4">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px;">
        <h3 class="notes-title" style="color: var(--dark); display: flex; align-items: center; gap: 12px;">
            <i class='bx bx-note' style="font-size: 28px; color: var(--warning);"></i>Mes notes
        </h3>
        {% if user.role != 'observateur' %}
        <button onclick="document.getElementById('ajouterNoteModal').style.display='block'" style="padding: 10px 20px; background: var(--primary); color: var(--light); border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;">
            <i class='bx bx-plus'></i>Nouvelle note
        </button>
        {% else %}
        <div style="padding: 10px 20px; background: var(--light-warning); color: var(--dark); border-radius: 8px; display: flex; align-items: center; gap: 8px;">
            <i class='bx bx-info-circle'></i>Mode observateur : Lecture seule
        </div>
        {% endif %}
    </div>

    <!-- NOTES GRID -->
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px;">
        {% for note in notes %}
        <div style="background: {{ note.couleur_fond|default:'#FFF9C4' }}; padding: 20px; border-radius: 16px; border-left: 4px solid var(--warning); position: relative; transition: all 0.3s ease; cursor: pointer;" 
             onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 12px 24px rgba(0,0,0,0.15)'" 
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
             onclick="document.getElementById('editerNoteModal{{ note.id }}').style.display='block'">
            {% if user.role != 'observateur' %}
            <div style="position: absolute; top: 12px; right: 12px;">
                <button type="button" style="padding: 6px 12px; background: var(--dark); color: var(--light); border: none; border-radius: 50%; cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;" 
                        onclick="event.stopPropagation(); document.getElementById('editerNoteModal{{ note.id }}').style.display='block'">
                    <i class='bx bx-dots-vertical-rounded'></i>
                </button>
            </div>
            {% endif %}
            <h5 class="note-title" style="margin: 0 0 12px 0; color: var(--dark); font-weight: 600;">{{ note.titre }}</h5>
            <p class="note-content" style="color: var(--dark); white-space: pre-wrap; word-wrap: break-word; margin: 0 0 12px 0; line-height: 1.6;">{{ note.contenu }}</p>
            <small class="note-date" style="color: var(--dark-grey);">{{ note.date_modification|date:"d/m/Y H:i" }}</small>
        </div>

        <!-- MODAL ÉDITION -->
        {% if user.role != 'observateur' %}
        <div id="editerNoteModal{{ note.id }}" style="display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
            <div style="background: var(--light); margin: 5% auto; padding: 0; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <div style="padding: 24px; border-bottom: 1px solid var(--grey); display: flex; justify-content: space-between; align-items: center;">
                    <h5 style="margin: 0; color: var(--dark);">Éditer la note</h5>
                    <button onclick="document.getElementById('editerNoteModal{{ note.id }}').style.display='none'" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--dark);">&times;</button>
                </div>
                <form method="post">
                    {% csrf_token %}
                    <div style="padding: 24px;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500;">Titre</label>
                            <input type="text" name="titre" value="{{ note.titre }}" required
                                   style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500;">Contenu</label>
                            <textarea name="contenu" rows="5" required
                                      style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none; resize: vertical;">{{ note.contenu }}</textarea>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500;">Couleur de fond</label>
                            <input type="color" name="couleur_fond" value="{{ note.couleur_fond|default:'#FFF9C4' }}" 
                                   style="width: 100%; height: 50px; border: 1px solid var(--grey); border-radius: 8px; cursor: pointer;">
                        </div>
                    </div>
                    <div style="padding: 24px; border-top: 1px solid var(--grey); display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="submit" name="modifier" style="padding: 10px 20px; background: var(--primary); color: var(--light); border: none; border-radius: 8px; cursor: pointer;">Modifier</button>
                        <button type="submit" name="supprimer" onclick="return confirm('Supprimer cette note ?');" style="padding: 10px 20px; background: var(--danger); color: var(--light); border: none; border-radius: 8px; cursor: pointer;">Supprimer</button>
                        <button type="button" onclick="document.getElementById('editerNoteModal{{ note.id }}').style.display='none'" style="padding: 10px 20px; background: var(--grey); color: var(--dark); border: none; border-radius: 8px; cursor: pointer;">Annuler</button>
                    </div>
                    <input type="hidden" name="note_id" value="{{ note.id }}">
                </form>
            </div>
        </div>
        {% endif %}
        {% empty %}
        <div class="notes-empty" style="grid-column: 1 / -1; text-align: center; padding: 48px; color: var(--dark-grey);">
            <i class='bx bx-note' style="font-size: 4rem; display: block; margin-bottom: 16px; opacity: 0.5;"></i>
            <p>Aucune note. Créez-en une !</p>
        </div>
        {% endfor %}
    </div>
</div>

<style>
/* Styles pour le mode nuit sur la page notes */
body.dark .notes-title {
    color: #ffffff !important;
}
body.dark .note-title {
    color: #ffffff !important;
}
body.dark .note-content {
    color: #ffffff !important;
}
body.dark .note-date {
    color: rgba(255, 255, 255, 0.8) !important;
}
body.dark .notes-empty {
    color: rgba(255, 255, 255, 0.7) !important;
}
body.dark .notes-empty p {
    color: rgba(255, 255, 255, 0.7) !important;
}
</style>

<!-- MODAL AJOUTER NOTE -->
{% if user.role != 'observateur' %}
<div id="ajouterNoteModal" style="display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
    <div style="background: var(--light); margin: 5% auto; padding: 0; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="padding: 24px; border-bottom: 1px solid var(--grey); display: flex; justify-content: space-between; align-items: center;">
            <h5 style="margin: 0; color: var(--dark);">Nouvelle note</h5>
            <button onclick="document.getElementById('ajouterNoteModal').style.display='none'" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--dark);">&times;</button>
        </div>
        <form method="post">
            {% csrf_token %}
            <div style="padding: 24px;">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500;">Titre</label>
                    <input type="text" name="titre" placeholder="Ex: Allergies d'Arthur" required
                           style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500;">Contenu</label>
                    <textarea name="contenu" rows="5" placeholder="Écrivez votre note..." required
                              style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none; resize: vertical;"></textarea>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500;">Couleur de fond</label>
                    <input type="color" name="couleur_fond" value="#FFF9C4" 
                           style="width: 100%; height: 50px; border: 1px solid var(--grey); border-radius: 8px; cursor: pointer;">
                </div>
            </div>
            <div style="padding: 24px; border-top: 1px solid var(--grey); display: flex; gap: 12px; justify-content: flex-end;">
                <button type="submit" name="ajouter" style="padding: 10px 20px; background: var(--primary); color: var(--light); border: none; border-radius: 8px; cursor: pointer;">Créer</button>
                <button type="button" onclick="document.getElementById('ajouterNoteModal').style.display='none'" style="padding: 10px 20px; background: var(--grey); color: var(--dark); border: none; border-radius: 8px; cursor: pointer;">Annuler</button>
            </div>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}
