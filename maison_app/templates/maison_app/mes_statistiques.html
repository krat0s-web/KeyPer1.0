{% extends "maison_app/dashboard_base.html" %}
{% load static %}
{% block title %}Mes Statistiques{% endblock %}
{% block page_title %}Mes Statistiques{% endblock %}
{% block page_heading %}Mes Statistiques{% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
    <li><a href="{% url 'dashboard' %}">Dashboard</a></li>
    /
    <li><a href="{% url 'mon_profil' %}">Mon Profil</a></li>
    /
    <li><a href="#" class="active">Statistiques</a></li>
</ul>
{% endblock %}

{% block page_content %}
<!-- Statistiques Globales -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px;">
    <div class="card-dashboard" style="border-left: 4px solid var(--primary);">
        <div style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 60px; height: 60px; background: var(--light-primary); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i class='bx bx-check-circle' style="font-size: 32px; color: var(--primary);"></i>
            </div>
            <div>
                <h3 style="margin: 0; font-size: 32px; font-weight: 700; color: var(--dark);">{{ total_taches }}</h3>
                <p style="margin: 4px 0 0 0; color: var(--dark-grey); font-size: 14px;">Tâches complétées</p>
            </div>
        </div>
    </div>
    
    <div class="card-dashboard" style="border-left: 4px solid var(--success);">
        <div style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 60px; height: 60px; background: var(--light-success); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i class='bx bx-calendar-week' style="font-size: 32px; color: var(--success);"></i>
            </div>
            <div>
                <h3 style="margin: 0; font-size: 32px; font-weight: 700; color: var(--dark);">{{ taches_semaine }}</h3>
                <p style="margin: 4px 0 0 0; color: var(--dark-grey); font-size: 14px;">Cette semaine</p>
            </div>
        </div>
    </div>
    
    <div class="card-dashboard" style="border-left: 4px solid var(--warning);">
        <div style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 60px; height: 60px; background: var(--light-warning); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i class='bx bx-calendar' style="font-size: 32px; color: var(--warning);"></i>
            </div>
            <div>
                <h3 style="margin: 0; font-size: 32px; font-weight: 700; color: var(--dark);">{{ taches_mois }}</h3>
                <p style="margin: 4px 0 0 0; color: var(--dark-grey); font-size: 14px;">Ce mois</p>
            </div>
        </div>
    </div>
    
    <div class="card-dashboard" style="border-left: 4px solid var(--info);">
        <div style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 60px; height: 60px; background: var(--light-info); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i class='bx bx-time' style="font-size: 32px; color: var(--info);"></i>
            </div>
            <div>
                <h3 style="margin: 0; font-size: 24px; font-weight: 700; color: var(--dark);" id="total_temps_display">
                    Calcul en cours...
                </h3>
                <p style="margin: 4px 0 0 0; color: var(--dark-grey); font-size: 14px;">Temps total</p>
            </div>
        </div>
    </div>
</div>

<!-- Graphique des 14 derniers jours -->
<div class="card-dashboard" style="margin-bottom: 24px;">
    <h3 style="font-size: 20px; font-weight: 600; color: var(--dark); margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
        <i class='bx bx-line-chart' style="color: var(--primary);"></i>Évolution des 14 derniers jours
    </h3>
    <canvas id="statsChart" style="max-height: 300px;"></canvas>
</div>

<!-- Historique détaillé -->
<div class="card-dashboard">
    <h3 style="font-size: 20px; font-weight: 600; color: var(--dark); margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
        <i class='bx bx-history' style="color: var(--primary);"></i>Historique détaillé (30 derniers jours)
    </h3>
    
    {% if stats %}
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: var(--grey);">
                    <th style="padding: 12px; text-align: left; color: var(--dark); font-weight: 600; border-bottom: 2px solid var(--grey);">Date</th>
                    <th style="padding: 12px; text-align: center; color: var(--dark); font-weight: 600; border-bottom: 2px solid var(--grey);">Tâches complétées</th>
                    <th style="padding: 12px; text-align: center; color: var(--dark); font-weight: 600; border-bottom: 2px solid var(--grey);">Temps</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in stats %}
                <tr style="border-bottom: 1px solid var(--grey);">
                    <td style="padding: 12px; color: var(--dark);">{{ stat.date_stat|date:"d/m/Y" }}</td>
                    <td style="padding: 12px; text-align: center; color: var(--dark); font-weight: 500;">{{ stat.nb_taches_done }}</td>
                    <td style="padding: 12px; text-align: center; color: var(--dark-grey);">
                        {% if stat.temps_connexion %}
                            {{ stat.temps_connexion|time:"H:i" }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 48px; color: var(--dark-grey);">
        <i class='bx bx-info-circle' style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
        <p>Aucune statistique disponible pour le moment.</p>
        <p style="font-size: 14px; margin-top: 8px;">Complétez des tâches pour voir vos statistiques !</p>
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Afficher le temps total
const totalSeconds = {{ total_temps.total_seconds }};
if (totalSeconds > 0) {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    document.getElementById('total_temps_display').textContent = hours + 'h ' + minutes + 'min';
} else {
    document.getElementById('total_temps_display').textContent = '0h';
}

// Graphique
const ctx = document.getElementById('statsChart');
if (ctx) {
    const dates = {{ dates|safe }};
    const taches = {{ taches_par_jour|safe }};
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Tâches complétées',
                data: taches,
                borderColor: 'var(--primary)',
                backgroundColor: 'rgba(74, 144, 226, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}

