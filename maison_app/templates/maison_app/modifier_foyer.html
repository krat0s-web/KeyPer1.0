{% extends "maison_app/dashboard_base.html" %}
{% load static %}
{% load permission_tags %}
{% block page_title %}Modifier le Foyer{% endblock %}
{% block page_heading %}Modifier le Foyer{% endblock %}

{% block breadcrumb %}
<ul class="breadcrumb">
    <li><a href="{% url 'dashboard' %}">Dashboard</a></li>
    /
    <li><a href="{% url 'liste_foyers' %}">Foyers</a></li>
    /
    <li><a href="{% url 'detail_foyer' foyer.id %}">{{ foyer.nom }}</a></li>
    /
    <li><a href="#" class="active">Modifier</a></li>
</ul>
{% endblock %}

{% block page_content %}
<div class="card-dashboard" style="max-width: 800px; margin: 0 auto;">
    <div style="background: linear-gradient(135deg, var(--primary), var(--light-primary)); color: #FFFFFF; padding: 24px; border-radius: 12px 12px 0 0;">
        <h3 style="margin: 0; color: #FFFFFF !important; display: flex; align-items: center; gap: 12px; font-weight: 600;">
            <i class='bx bx-edit' style="font-size: 28px; color: #FFFFFF;"></i>Modifier le Foyer : {{ foyer.nom }}
        </h3>
    </div>
    <div style="padding: 24px;">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500; display: flex; align-items: center; gap: 4px;">
                    <i class='bx bx-home'></i>Nom du foyer <span style="color: var(--danger);">*</span>
                </label>
                <input type="text" name="nom" value="{{ foyer.nom }}" required
                       style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500; display: flex; align-items: center; gap: 4px;">
                    <i class='bx bx-text'></i>Description
                </label>
                <textarea name="description" rows="4" placeholder="Description du foyer..."
                          style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none; resize: vertical;">{{ foyer.description|default:'' }}</textarea>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500; display: flex; align-items: center; gap: 4px;">
                    <i class='bx bx-image'></i>Photo du foyer
                </label>
                {% if foyer.photo %}
                <div style="margin-bottom: 12px;">
                    <img src="{{ foyer.photo.url }}" alt="{{ foyer.nom }}" style="max-height: 200px; border-radius: 8px; border: 2px solid var(--grey);">
                    <p style="color: var(--dark-grey); font-size: 12px; margin-top: 8px;">Photo actuelle</p>
                </div>
                <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="supprimer_photo" id="supprimer_photo" style="width: 18px; height: 18px; cursor: pointer;">
                    <label for="supprimer_photo" style="color: var(--dark); cursor: pointer;">Supprimer la photo actuelle</label>
                </div>
                {% endif %}
                <input type="file" name="photo" accept="image/*"
                       style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                <small style="color: var(--dark-grey); font-size: 12px;">JPG, PNG (max 5MB). Laisser vide pour conserver la photo actuelle.</small>
            </div>
            
            <div class="card-dashboard" style="background: var(--light-primary); padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary);">
                <i class='bx bx-info-circle' style="color: var(--primary); margin-right: 8px;"></i>
                <strong style="color: var(--dark);">Note :</strong> Les modifications seront visibles imm√©diatement pour tous les membres du foyer.
            </div>
            
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button type="submit" style="flex: 1; min-width: 200px; padding: 12px 24px; background: var(--success); color: var(--light); border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease; font-weight: 500;">
                    <i class='bx bx-check-circle'></i>Enregistrer les modifications
                </button>
                <a href="{% url 'detail_foyer' foyer.id %}" style="flex: 1; min-width: 150px; padding: 12px 24px; background: var(--grey); color: var(--dark); border-radius: 8px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease; font-weight: 500;">
                    <i class='bx bx-x-circle'></i>Annuler
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Section Gestion des Membres -->
<div class="card-dashboard" style="max-width: 800px; margin: 24px auto 0;">
    <div style="background: linear-gradient(135deg, var(--primary), var(--light-primary)); color: #FFFFFF; padding: 24px; border-radius: 12px 12px 0 0;">
        <h3 style="margin: 0; color: #FFFFFF !important; display: flex; align-items: center; gap: 12px; font-weight: 600;">
            <i class='bx bx-group' style="font-size: 28px; color: #FFFFFF;"></i>Gestion des Membres
        </h3>
    </div>
    <div style="padding: 24px;">
        <!-- Ajouter un membre -->
        <div style="margin-bottom: 32px;">
            <h5 style="margin: 0 0 16px 0; color: var(--dark); display: flex; align-items: center; gap: 8px;">
                <i class='bx bx-user-plus' style="color: var(--primary);"></i>Ajouter un membre
            </h5>
            <form method="post" style="display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: end;">
                {% csrf_token %}
                <input type="hidden" name="action" value="ajouter_membre">
                <div>
                    <input type="email" name="email_membre" placeholder="Email du membre √† ajouter" required
                           style="width: 100%; padding: 12px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                </div>
                <div>
                    <button type="submit" style="padding: 12px 24px; background: var(--primary); color: var(--light); border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; font-weight: 500; white-space: nowrap;">
                        <i class='bx bx-plus-circle'></i>Ajouter
                    </button>
                </div>
            </form>
            <small style="color: var(--dark-grey); font-size: 12px; display: flex; align-items: center; gap: 4px; margin-top: 8px;">
                <i class='bx bx-info-circle'></i>
                L'utilisateur doit avoir un compte existant sur la plateforme.
            </small>
        </div>

        <hr style="border: none; border-top: 1px solid var(--grey); margin: 24px 0;">

        <!-- Liste des membres -->
        <div>
            <h5 style="margin: 0 0 16px 0; color: var(--dark); display: flex; align-items: center; gap: 8px;">
                <i class='bx bx-group' style="color: var(--primary);"></i>Membres du foyer ({{ membres_foyer|length }})
            </h5>
            <div class="card-dashboard" style="background: var(--light-primary); padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid var(--primary);">
                <i class='bx bx-info-circle' style="color: var(--primary); margin-right: 8px;"></i>
                <small style="color: var(--dark); font-size: 12px;">
                    <strong>üí° Permissions Budget :</strong> Cochez la case pour autoriser l'acc√®s complet au budget (cr√©ation de budgets, d√©penses, etc.) pour cet utilisateur dans ce foyer.
                </small>
            </div>
            {% if membres_foyer %}
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--grey);">
                            <th style="padding: 12px; text-align: left; color: var(--dark); font-weight: 600;">Email</th>
                            <th style="padding: 12px; text-align: left; color: var(--dark); font-weight: 600;">Nom</th>
                            <th style="padding: 12px; text-align: left; color: var(--dark); font-weight: 600;">R√¥le</th>
                            <th style="padding: 12px; text-align: left; color: var(--dark); font-weight: 600;">üí∞ Acc√®s Budget</th>
                            <th style="padding: 12px; text-align: left; color: var(--dark); font-weight: 600;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for membre in membres_foyer %}
                        <tr style="border-bottom: 1px solid var(--grey);">
                            <td style="padding: 12px; color: var(--dark);">{{ membre.email }}</td>
                            <td style="padding: 12px; color: var(--dark);">{{ membre.nom|default:"-" }}</td>
                            <td style="padding: 12px;">
                                <span style="padding: 4px 8px; background: var(--grey); color: var(--dark); border-radius: 12px; font-size: 12px;">{{ membre.get_role_display|default:"Membre" }}</span>
                            </td>
                            <td style="padding: 12px;">
                                {% if membre.id != user.id %}
                                <form method="post" id="form_permissions_{{ membre.id }}" style="display: inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="modifier_permissions_budget">
                                    <input type="hidden" name="membre_id" value="{{ membre.id }}">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        {% with perm_value=permissions_budget|get_item:membre.id|default:False %}
                                        <input type="checkbox" name="can_access_budget" 
                                               {% if perm_value %}checked{% endif %}
                                               onchange="document.getElementById('form_permissions_{{ membre.id }}').submit();"
                                               style="width: 20px; height: 20px; cursor: pointer;">
                                        <span style="color: var(--dark); font-size: 14px;" id="status_permissions_{{ membre.id }}">
                                            {% if perm_value %}
                                                <span style="color: var(--success); font-weight: 600;">‚úÖ Autoris√©</span>
                                            {% else %}
                                                <span style="color: var(--dark-grey);">‚ùå Non autoris√©</span>
                                            {% endif %}
                                        </span>
                                        {% endwith %}
                                    </label>
                                </form>
                                {% else %}
                                <span style="color: var(--dark-grey); font-size: 12px;">Admin</span>
                                {% endif %}
                            </td>
                            <td style="padding: 12px;">
                                {% if membre.id != user.id %}
                                <form method="post" style="display: inline;" onsubmit="return confirm('√ätes-vous s√ªr de vouloir retirer {{ membre.email }} du foyer ?');">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="supprimer_membre">
                                    <input type="hidden" name="membre_id" value="{{ membre.id }}">
                                    <button type="submit" style="padding: 6px 12px; background: var(--danger); color: var(--light); border: none; border-radius: 8px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; font-size: 12px; transition: all 0.3s ease;">
                                        <i class='bx bx-trash'></i>Retirer
                                    </button>
                                </form>
                                {% else %}
                                <span style="color: var(--dark-grey); font-size: 12px;">Vous</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="card-dashboard" style="background: var(--light-primary); padding: 24px; border-radius: 8px; text-align: center; border-left: 4px solid var(--primary);">
                <i class='bx bx-info-circle' style="color: var(--primary); font-size: 2rem; margin-bottom: 8px; display: block;"></i>
                <p style="margin: 0; color: var(--dark);">Aucun membre dans ce foyer pour le moment.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Section Gestion des Animaux -->
<div class="card-dashboard" style="max-width: 800px; margin: 24px auto 0;">
    <div style="background: linear-gradient(135deg, var(--success), #4CAF50); color: #FFFFFF; padding: 24px; border-radius: 12px 12px 0 0;">
        <h3 style="margin: 0; color: #FFFFFF !important; display: flex; align-items: center; gap: 12px; font-weight: 600;">
            <i class='bx bx-dog' style="font-size: 28px; color: #FFFFFF;"></i>Gestion des Animaux
        </h3>
    </div>
    <div style="padding: 24px;">
        <!-- Liste des animaux -->
        <div>
            <h5 style="margin: 0 0 16px 0; color: var(--dark); display: flex; align-items: center; gap: 8px;">
                <i class='bx bx-dog' style="color: var(--success);"></i>Animaux du foyer ({{ animaux_foyer|length }})
            </h5>
            {% if animaux_foyer %}
            <div style="display: grid; gap: 16px;">
                {% for animal in animaux_foyer %}
                <div class="card-dashboard" style="padding: 16px; border-left: 4px solid var(--success);">
                    <form method="post" enctype="multipart/form-data" id="form-animal-{{ animal.id }}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="modifier_animal">
                        <input type="hidden" name="animal_id" value="{{ animal.id }}">
                        
                        <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 16px; align-items: start;">
                            <!-- Photo de l'animal -->
                            <div style="min-width: 100px;">
                                {% if animal.photo %}
                                <img src="{{ animal.photo.url }}" alt="{{ animal.nom }}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid var(--grey);">
                                {% else %}
                                <div style="width: 100px; height: 100px; background: var(--grey); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <i class='bx bx-dog' style="font-size: 2rem; color: var(--dark-grey);"></i>
                                </div>
                                {% endif %}
                                <div style="margin-top: 8px;">
                                    <input type="file" name="photo_animal" accept="image/*" style="width: 100%; padding: 6px; border: 1px solid var(--grey); border-radius: 4px; font-size: 12px;">
                                    {% if animal.photo %}
                                    <div style="margin-top: 4px;">
                                        <input type="checkbox" name="supprimer_photo_animal" id="supprimer_photo_{{ animal.id }}" style="width: 14px; height: 14px;">
                                        <label for="supprimer_photo_{{ animal.id }}" style="font-size: 11px; color: var(--dark-grey); cursor: pointer;">Supprimer</label>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Informations de l'animal -->
                            <div style="flex: 1;">
                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; margin-bottom: 4px; color: var(--dark); font-weight: 500; font-size: 14px;">Nom de l'animal</label>
                                    <input type="text" name="nom_animal" value="{{ animal.nom }}" required
                                           style="width: 100%; padding: 8px; border: 1px solid var(--grey); border-radius: 6px; background: var(--light); color: var(--dark); outline: none;">
                                </div>
                                
                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; margin-bottom: 4px; color: var(--dark); font-weight: 500; font-size: 14px;">Pi√®ce</label>
                                    <select name="piece_id" style="width: 100%; padding: 8px; border: 1px solid var(--grey); border-radius: 6px; background: var(--light); color: var(--dark); outline: none;">
                                        <option value="">Aucune pi√®ce</option>
                                        {% for piece in pieces_foyer %}
                                        <option value="{{ piece.id }}" {% if animal.id_piece and animal.id_piece.id == piece.id %}selected{% endif %}>{{ piece.nom }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div style="display: flex; gap: 8px;">
                                    <button type="submit" style="padding: 8px 16px; background: var(--success); color: var(--light); border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; font-size: 13px; transition: all 0.3s ease;">
                                        <i class='bx bx-save'></i>Enregistrer
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Bouton supprimer -->
                            <div>
                                <form method="post" style="display: inline;" onsubmit="return confirm('√ätes-vous s√ªr de vouloir supprimer l\'animal {{ animal.nom }} ?');">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="supprimer_animal">
                                    <input type="hidden" name="animal_id" value="{{ animal.id }}">
                                    <button type="submit" style="padding: 8px 16px; background: var(--danger); color: var(--light); border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; font-size: 13px; transition: all 0.3s ease;">
                                        <i class='bx bx-trash'></i>Supprimer
                                    </button>
                                </form>
                            </div>
                        </div>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card-dashboard" style="background: var(--light-primary); padding: 24px; border-radius: 8px; text-align: center; border-left: 4px solid var(--success);">
                <i class='bx bx-dog' style="color: var(--success); font-size: 2rem; margin-bottom: 8px; display: block;"></i>
                <p style="margin: 0; color: var(--dark);">Aucun animal dans ce foyer pour le moment.</p>
                <a href="{% url 'ajouter_animal' %}" style="display: inline-block; margin-top: 12px; padding: 8px 16px; background: var(--success); color: var(--light); border-radius: 6px; text-decoration: none; font-size: 14px;">
                    <i class='bx bx-plus'></i>Ajouter un animal
                </a>
            </div>
            {% endif %}
        </div>
        
        {% if animaux_foyer %}
        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--grey);">
            <a href="{% url 'ajouter_animal' %}" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: var(--success); color: var(--light); border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.3s ease;">
                <i class='bx bx-plus-circle'></i>Ajouter un nouvel animal
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Section Gestion des Pi√®ces -->
<div class="card-dashboard" style="max-width: 800px; margin: 24px auto 0;">
    <div style="background: linear-gradient(135deg, var(--warning), #ffc107); color: #FFFFFF; padding: 24px; border-radius: 12px 12px 0 0;">
        <h3 style="margin: 0; color: #FFFFFF !important; display: flex; align-items: center; gap: 12px; font-weight: 600;">
            <i class='bx bx-door-open' style="font-size: 28px; color: #FFFFFF;"></i>Gestion des Pi√®ces
        </h3>
    </div>
    <div style="padding: 24px;">
        <!-- Ajouter une pi√®ce -->
        <div style="margin-bottom: 32px;">
            <h5 style="margin: 0 0 16px 0; color: var(--dark); display: flex; align-items: center; gap: 8px;">
                <i class='bx bx-plus-circle' style="color: var(--warning);"></i>Ajouter une pi√®ce
            </h5>
            <form method="post" enctype="multipart/form-data" style="display: grid; gap: 16px;">
                {% csrf_token %}
                <input type="hidden" name="action" value="ajouter_piece">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500; font-size: 14px;">Nom de la pi√®ce <span style="color: var(--danger);">*</span></label>
                        <input type="text" name="nom_piece" placeholder="Ex: Cuisine" required
                               style="width: 100%; padding: 10px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500; font-size: 14px;">Type de pi√®ce</label>
                        <select name="type_piece" style="width: 100%; padding: 10px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                            <option value="personnalise">Personnalis√©</option>
                            <option value="cuisine">Cuisine</option>
                            <option value="chambre">Chambre</option>
                            <option value="salon">Salon</option>
                            <option value="salle_de_bain">Salle de bain</option>
                            <option value="toilettes">Toilettes</option>
                            <option value="bureau">Bureau</option>
                            <option value="jardin">Jardin</option>
                            <option value="garage">Garage</option>
                            <option value="salle_de_jeux">Salle de jeux</option>
                            <option value="buanderie">Buanderie</option>
                            <option value="salle_a_manger">Salle √† manger</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500; font-size: 14px;">Description</label>
                    <textarea name="description_piece" rows="2" placeholder="Description de la pi√®ce (optionnel)"
                              style="width: 100%; padding: 10px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none; resize: vertical;"></textarea>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500; font-size: 14px;">Photo (optionnel)</label>
                    <input type="file" name="photo_piece" accept="image/*"
                           style="width: 100%; padding: 10px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--dark); font-weight: 500; font-size: 14px;">Acc√®s restreint (optionnel)</label>
                    <select name="utilisateurs_autorises_piece" multiple size="4"
                            style="width: 100%; padding: 10px; border: 1px solid var(--grey); border-radius: 8px; background: var(--light); color: var(--dark); outline: none;">
                        {% for membre in membres_foyer %}
                        <option value="{{ membre.id }}">{{ membre.nom|default:membre.email }}</option>
                        {% endfor %}
                    </select>
                    <small style="color: var(--dark-grey); font-size: 12px;">Maintenez Ctrl (Cmd sur Mac) pour s√©lectionner plusieurs utilisateurs. Si aucun n'est s√©lectionn√©, tous les membres peuvent acc√©der.</small>
                </div>
                
                <div>
                    <button type="submit" style="padding: 10px 20px; background: var(--warning); color: var(--dark); border: none; border-radius: 8px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; transition: all 0.3s ease;">
                        <i class='bx bx-plus-circle'></i>Ajouter la pi√®ce
                    </button>
                </div>
            </form>
        </div>

        <hr style="border: none; border-top: 1px solid var(--grey); margin: 24px 0;">

        <!-- Liste des pi√®ces -->
        <div>
            <h5 style="margin: 0 0 16px 0; color: var(--dark); display: flex; align-items: center; gap: 8px;">
                <i class='bx bx-door-open' style="color: var(--warning);"></i>Pi√®ces du foyer ({{ pieces_foyer|length }})
            </h5>
            {% if pieces_foyer %}
            <div style="display: grid; gap: 16px;">
                {% for piece in pieces_foyer %}
                <div class="card-dashboard" style="padding: 16px; border-left: 4px solid var(--warning);">
                    <form method="post" enctype="multipart/form-data" id="form-piece-{{ piece.id }}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="modifier_piece">
                        <input type="hidden" name="piece_id" value="{{ piece.id }}">
                        
                        <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 16px; align-items: start;">
                            <!-- Photo de la pi√®ce -->
                            <div style="min-width: 100px;">
                                {% if piece.photo %}
                                <img src="{{ piece.photo.url }}" alt="{{ piece.nom }}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid var(--grey);">
                                {% else %}
                                <div style="width: 100px; height: 100px; background: var(--grey); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <i class='bx bx-door-open' style="font-size: 2rem; color: var(--dark-grey);"></i>
                                </div>
                                {% endif %}
                                <div style="margin-top: 8px;">
                                    <input type="file" name="photo_piece" accept="image/*" style="width: 100%; padding: 6px; border: 1px solid var(--grey); border-radius: 4px; font-size: 12px;">
                                    {% if piece.photo %}
                                    <div style="margin-top: 4px;">
                                        <input type="checkbox" name="supprimer_photo_piece" id="supprimer_photo_piece_{{ piece.id }}" style="width: 14px; height: 14px;">
                                        <label for="supprimer_photo_piece_{{ piece.id }}" style="font-size: 11px; color: var(--dark-grey); cursor: pointer;">Supprimer</label>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Informations de la pi√®ce -->
                            <div style="flex: 1;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; color: var(--dark); font-weight: 500; font-size: 14px;">Nom</label>
                                        <input type="text" name="nom_piece" value="{{ piece.nom }}" required
                                               style="width: 100%; padding: 8px; border: 1px solid var(--grey); border-radius: 6px; background: var(--light); color: var(--dark); outline: none;">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; color: var(--dark); font-weight: 500; font-size: 14px;">Type</label>
                                        <select name="type_piece" style="width: 100%; padding: 8px; border: 1px solid var(--grey); border-radius: 6px; background: var(--light); color: var(--dark); outline: none;">
                                            <option value="personnalise" {% if piece.type_piece == 'personnalise' %}selected{% endif %}>Personnalis√©</option>
                                            <option value="cuisine" {% if piece.type_piece == 'cuisine' %}selected{% endif %}>Cuisine</option>
                                            <option value="chambre" {% if piece.type_piece == 'chambre' %}selected{% endif %}>Chambre</option>
                                            <option value="salon" {% if piece.type_piece == 'salon' %}selected{% endif %}>Salon</option>
                                            <option value="salle_de_bain" {% if piece.type_piece == 'salle_de_bain' %}selected{% endif %}>Salle de bain</option>
                                            <option value="toilettes" {% if piece.type_piece == 'toilettes' %}selected{% endif %}>Toilettes</option>
                                            <option value="bureau" {% if piece.type_piece == 'bureau' %}selected{% endif %}>Bureau</option>
                                            <option value="jardin" {% if piece.type_piece == 'jardin' %}selected{% endif %}>Jardin</option>
                                            <option value="garage" {% if piece.type_piece == 'garage' %}selected{% endif %}>Garage</option>
                                            <option value="salle_de_jeux" {% if piece.type_piece == 'salle_de_jeux' %}selected{% endif %}>Salle de jeux</option>
                                            <option value="buanderie" {% if piece.type_piece == 'buanderie' %}selected{% endif %}>Buanderie</option>
                                            <option value="salle_a_manger" {% if piece.type_piece == 'salle_a_manger' %}selected{% endif %}>Salle √† manger</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; margin-bottom: 4px; color: var(--dark); font-weight: 500; font-size: 14px;">Description</label>
                                    <textarea name="description_piece" rows="2" style="width: 100%; padding: 8px; border: 1px solid var(--grey); border-radius: 6px; background: var(--light); color: var(--dark); outline: none; resize: vertical;">{{ piece.description|default:'' }}</textarea>
                                </div>
                                
                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; margin-bottom: 4px; color: var(--dark); font-weight: 500; font-size: 14px;">Acc√®s restreint</label>
                                    <select name="utilisateurs_autorises_piece" multiple size="3" style="width: 100%; padding: 8px; border: 1px solid var(--grey); border-radius: 6px; background: var(--light); color: var(--dark); outline: none;">
                                        {% for membre in membres_foyer %}
                                        <option value="{{ membre.id }}" {% if membre in piece.utilisateurs_autorises.all %}selected{% endif %}>{{ membre.nom|default:membre.email }}</option>
                                        {% endfor %}
                                    </select>
                                    <small style="color: var(--dark-grey); font-size: 11px;">Maintenez Ctrl (Cmd sur Mac) pour s√©lectionner plusieurs utilisateurs.</small>
                                </div>
                                
                                <div style="display: flex; gap: 8px;">
                                    <button type="submit" style="padding: 8px 16px; background: var(--warning); color: var(--dark); border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; font-size: 13px; transition: all 0.3s ease;">
                                        <i class='bx bx-save'></i>Enregistrer
                                    </button>
                                    {% if piece.type_piece == 'cuisine' %}
                                    <a href="{% url 'cuisine_view' piece.id %}" style="padding: 8px 16px; background: var(--primary); color: var(--light); border-radius: 6px; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; font-size: 13px; transition: all 0.3s ease;">
                                        <i class='bx bx-food-menu'></i>Voir la cuisine
                                    </a>
                                    {% else %}
                                    <a href="{% url 'detail_piece' piece.id %}" style="padding: 8px 16px; background: var(--primary); color: var(--light); border-radius: 6px; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; font-size: 13px; transition: all 0.3s ease;">
                                        <i class='bx bx-show'></i>Voir la pi√®ce
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Bouton supprimer -->
                            <div>
                                <form method="post" style="display: inline;" onsubmit="return confirm('√ätes-vous s√ªr de vouloir supprimer la pi√®ce {{ piece.nom }} ? Toutes les t√¢ches et donn√©es associ√©es seront √©galement supprim√©es.');">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="supprimer_piece">
                                    <input type="hidden" name="piece_id" value="{{ piece.id }}">
                                    <button type="submit" style="padding: 8px 16px; background: var(--danger); color: var(--light); border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; font-size: 13px; transition: all 0.3s ease;">
                                        <i class='bx bx-trash'></i>Supprimer
                                    </button>
                                </form>
                            </div>
                        </div>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card-dashboard" style="background: var(--light-primary); padding: 24px; border-radius: 8px; text-align: center; border-left: 4px solid var(--warning);">
                <i class='bx bx-door-open' style="color: var(--warning); font-size: 2rem; margin-bottom: 8px; display: block;"></i>
                <p style="margin: 0; color: var(--dark);">Aucune pi√®ce dans ce foyer pour le moment.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

